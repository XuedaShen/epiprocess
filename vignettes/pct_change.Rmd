---
title: 2. Compute percentage change over time
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{2. Compute percentage change over time}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

A basic way of assessing growth in a signal is to look at its percentage change
over two neighboring time windows. We investigate this in the current vignette,
using the `pct_change()` convenience function from the `epiprocess` package,
inside of a call to `epi_slide()`. As before, we'll look at state-level daily
reported COVID-19 cases.

```{r, message = FALSE}
library(covidcast)
library(epiprocess)
library(dplyr)

x <- covidcast_signal(data_source = "jhu-csse", 
                      signal = "confirmed_incidence_num",
                      start_day = "2020-06-01", 
                      end_day = "2021-05-31",
                      geo_type = "state", 
                      geo_values = "fl")  %>%
  as.epi_df() %>%
  rename(cases = value) %>%
  select(geo_value, time_value, cases)
```

## Percentage change

The `pct_change()` function is a simple convenience function that takes a single
argument `var`, the variable whose percentage change is to be computed. If `var`
has length N, which is assumed to be even, and A and B denote the sum of the
first N/2 and last N/2 values in `var`, respectively, then `pct_change(var)`
returns 100 * (B - A) / A. (If the length of `var` is odd, then its first value
is ignored, for the sake of the computation.)

Used in call to `epi_slide()`, we can fluidly compute percentage change values 
in a variable over time: 

```{r}
x <- epi_slide(x, pct_change = pct_change(cases), n = 14, complete = TRUE)
head(x, 21) %>% print(n = Inf)
```

Thus to be clear, the `pct_change` value computed on (for example) November 14  
is the percentage change between the total cases from November 1 to 7, and the
total from November 8 to November 14. The argument `complete = TRUE` in the call
to `epi_slide()` specifies that a complete window of `n = 14` time points must
be available for the computation, which is why values in the `pct_change` column
are `NA` from November 1 to 13.

Next we plot these values alongside the signal itself. We highlight the periods
in time for which the percentage change is above 10% (in red) and below -10% (in
blue).

```{r, message = FALSE, warning = FALSE, fig.width = 9, fig.height = 4}
library(ggplot2)
theme_set(theme_bw())

threshold_upper = 10
threshold_lower = -10

p1 <- ggplot(x, aes(x = time_value, y = cases)) + 
  geom_tile(data = x %>% filter(pct_change >= threshold_upper),
            aes(x = time_value, y = 0, width = 7, height = Inf), 
            fill = 2, alpha = 0.1) + 
  geom_tile(data = x %>% filter(pct_change <= threshold_lower),
            aes(x = time_value, y = 0, width = 7, height = Inf), 
            fill = 4, alpha = 0.1) +  
  geom_line() + 
  scale_x_date(minor_breaks = "month", date_labels = "%b %y") +
  labs(x = "Date", y = "Reported COVID-19 cases")

p2 <- ggplot(x, aes(x = time_value, y = pct_change)) + 
  geom_line() + 
  geom_hline(yintercept = threshold_upper, linetype = 2, col = 2) +
  geom_hline(yintercept = threshold_lower, linetype = 2, col = 4) +
  scale_x_date(minor_breaks = "month", date_labels = "%b %y") +
  labs(x = "Date", y = "Weekly percentage change") 

gridExtra::grid.arrange(p1, p2, nrow = 1)
```

## Smoothing via 7-day averaging

The percentage change in the last figure appears pretty volatile in some parts, 
which is not too surprising, looking at how wiggly the signal is itself. With a
suitable call to `epi_slide()`, we can either pre-smooth or post-smooth using a
7-day trailing average. The differences here (between these two approaches) do 
not end up being very noticeable at all (which is not unexpected, due to the way
in which percentage change is defined; it is already defined using a sum over a 
7-day period). We just show results for one of these approaches, pre-smoothing.

```{r, message = FALSE, warning = FALSE, fig.width = 9, fig.height = 4}
x <- x %>%
  epi_slide(cases_7dav = mean(cases), n = 7) %>%
  epi_slide(pct_change = pct_change(cases_7dav), n = 14, complete = TRUE)

p1 <- ggplot(x, aes(x = time_value, y = cases_7dav)) + 
  geom_tile(data = x %>% filter(pct_change >= threshold_upper),
            aes(x = time_value, y = 0, width = 7, height = Inf), 
            fill = 2, alpha = 0.1) + 
  geom_tile(data = x %>% filter(pct_change <= threshold_lower),
            aes(x = time_value, y = 0, width = 7, height = Inf), 
            fill = 4, alpha = 0.1) + 
  geom_line() + 
  scale_x_date(minor_breaks = "month", date_labels = "%b %y") +
  labs(x = "Date", y = "Reported COVID-19 cases (7-day average)")

p2 <- ggplot(x, aes(x = time_value, y = pct_change)) + 
  geom_line() + 
  geom_hline(yintercept = threshold_upper, linetype = 2, col = 2) +
  geom_hline(yintercept = threshold_lower, linetype = 2, col = 4) +
  scale_x_date(minor_breaks = "month", date_labels = "%b %y") +
  labs(x = "Date", y = "Weekly percentage change") 

gridExtra::grid.arrange(p1, p2, nrow = 1)
```