<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Advanced sliding with nonstandard outputs â€¢ epiprocess</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Advanced sliding with nonstandard outputs">
<meta property="og:description" content="epiprocess">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">epiprocess</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/epiprocess.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/slide.html">Slide a computation over signal values</a>
    </li>
    <li>
      <a href="../articles/growth_rate.html">Estimate growth rates in signals</a>
    </li>
    <li>
      <a href="../articles/correlation.html">Correlate signals over space and time</a>
    </li>
    <li>
      <a href="../articles/aggregation.html">Aggregate signals over space and time</a>
    </li>
    <li>
      <a href="../articles/outliers.html">Detect and correct outliers in signals</a>
    </li>
    <li>
      <a href="../articles/archive.html">Work with archive objects and data revisions</a>
    </li>
    <li>
      <a href="../articles/advanced.html">Advanced sliding with nonstandard outputs</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/cmu-delphi/epiprocess/tree/main/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="advanced_files/header-attrs-2.10/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Advanced sliding with nonstandard outputs</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/cmu-delphi/epiprocess/blob/main/vignettes/advanced.Rmd"><code>vignettes/advanced.Rmd</code></a></small>
      <div class="hidden name"><code>advanced.Rmd</code></div>

    </div>

    
    
<p>In this vignette, we discuss how to use the sliding functionality in the <code>epiprocess</code> package with computations that have advanced output structures.</p>
<p>In general, the functions <code><a href="../reference/epi_slide.html">epi_slide()</a></code> and <code><a href="../reference/epix_slide.html">epix_slide()</a></code> do what they can to ensure the result of a slide operation is <em>size stable</em>, meaning, it will return something whose length is the same as the number of appearances of reference time values for the slide computation in the given data frame/table (this defaults to all time values, but can be some given subset when <code>ref_time_values</code> is specified).</p>
<p>The output of a slide computation should either be an atomic value/vector, or a data frame. This data frame can have multiple columns, multiple rows, or both. Below we demonstrate some advanced use cases of sliding with these output structures. We focus on <code><a href="../reference/epi_slide.html">epi_slide()</a></code> for the most part, though the behavior we demonstrate also carries over to <code><a href="../reference/epix_slide.html">epix_slide()</a></code>.</p>
<div id="recycling-outputs" class="section level2">
<h2 class="hasAnchor">
<a href="#recycling-outputs" class="anchor"></a>Recycling outputs</h2>
<p>When a computation returns a single atomic value, <code><a href="../reference/epi_slide.html">epi_slide()</a></code> will internally try to recycle the output so that it is size stable (in the sense described above). We can use this to our advantage, for example, in order to compute a trailing average marginally over geo values, which we demonstrate below in a simple synthetic example.</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">epiprocess</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">dplyr</span>)

<span class="no">df</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/reexports.html">tibble</a></span>(
  <span class="kw">geo_value</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"ca"</span>, <span class="st">"fl"</span>, <span class="st">"pa"</span>), <span class="kw">each</span> <span class="kw">=</span> <span class="fl">3</span>),
  <span class="kw">time_value</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span>(<span class="st">"2020-06-01"</span>), <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span>(<span class="st">"2020-06-03"</span>),
                       <span class="kw">by</span> <span class="kw">=</span> <span class="st">"day"</span>), <span class="kw">length.out</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">geo_value</span>)),
  <span class="kw">x</span> <span class="kw">=</span> <span class="fl">1</span>:<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">geo_value</span>) + <span class="fl">0.01</span> * <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">geo_value</span>)),
) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/as_epi_df.html">as_epi_df</a></span>()

<span class="co"># 2-day trailing average, per geo value</span>
<span class="no">df</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(<span class="no">geo_value</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/epi_slide.html">epi_slide</a></span>(<span class="kw">x_2dav</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="no">x</span>), <span class="kw">n</span> <span class="kw">=</span> <span class="fl">2</span>)</pre></body></html></div>
<pre><code>## An `epi_df` object, with metadata:
## * geo_type  = state
## * time_type = day
## * as_of     = 2022-03-30 09:31:07
## 
## # A tibble: 9 Ã— 4
## # Groups:   geo_value [3]
##   geo_value time_value     x x_2dav
## * &lt;chr&gt;     &lt;date&gt;     &lt;dbl&gt;  &lt;dbl&gt;
## 1 ca        2020-06-01 0.992  0.992
## 2 ca        2020-06-02 1.98   1.49 
## 3 ca        2020-06-03 2.99   2.49 
## 4 fl        2020-06-01 4.00   4.00 
## 5 fl        2020-06-02 5.00   4.50 
## 6 fl        2020-06-03 6.00   5.50 
## 7 pa        2020-06-01 7.00   7.00 
## 8 pa        2020-06-02 8.00   7.50 
## 9 pa        2020-06-03 9.00   8.50</code></pre>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="co"># 2-day trailing average, marginally </span>
<span class="no">df</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/epi_slide.html">epi_slide</a></span>(<span class="kw">x_2dav</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="no">x</span>), <span class="kw">n</span> <span class="kw">=</span> <span class="fl">2</span>)</pre></body></html></div>
<pre><code>## An `epi_df` object, with metadata:
## * geo_type  = state
## * time_type = day
## * as_of     = 2022-03-30 09:31:07
## 
## # A tibble: 9 Ã— 4
##   geo_value time_value     x x_2dav
## * &lt;chr&gt;     &lt;date&gt;     &lt;dbl&gt;  &lt;dbl&gt;
## 1 ca        2020-06-01 0.992   3.99
## 2 fl        2020-06-01 4.00    3.99
## 3 pa        2020-06-01 7.00    3.99
## 4 ca        2020-06-02 1.98    4.49
## 5 fl        2020-06-02 5.00    4.49
## 6 pa        2020-06-02 8.00    4.49
## 7 ca        2020-06-03 2.99    5.50
## 8 fl        2020-06-03 6.00    5.50
## 9 pa        2020-06-03 9.00    5.50</code></pre>
<p>When the slide computation returns an atomic vector (rather than a single value) <code><a href="../reference/epi_slide.html">epi_slide()</a></code> checks whether its return length ensures size stability, and if so, uses it to fill the new column. For example, this next computation gives the same result as the last one.</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="no">df</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/epi_slide.html">epi_slide</a></span>(<span class="kw">y_2dav</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="no">x</span>), <span class="fl">3</span>), <span class="kw">n</span> <span class="kw">=</span> <span class="fl">2</span>)</pre></body></html></div>
<pre><code>## An `epi_df` object, with metadata:
## * geo_type  = state
## * time_type = day
## * as_of     = 2022-03-30 09:31:07
## 
## # A tibble: 9 Ã— 4
##   geo_value time_value     x y_2dav
## * &lt;chr&gt;     &lt;date&gt;     &lt;dbl&gt;  &lt;dbl&gt;
## 1 ca        2020-06-01 0.992   3.99
## 2 fl        2020-06-01 4.00    3.99
## 3 pa        2020-06-01 7.00    3.99
## 4 ca        2020-06-02 1.98    4.49
## 5 fl        2020-06-02 5.00    4.49
## 6 pa        2020-06-02 8.00    4.49
## 7 ca        2020-06-03 2.99    5.50
## 8 fl        2020-06-03 6.00    5.50
## 9 pa        2020-06-03 9.00    5.50</code></pre>
<p>However, if the output is an atomic vector (rather than a single value) and it is <em>not</em> size stable, then <code><a href="../reference/epi_slide.html">epi_slide()</a></code> throws an error. For example, below we are trying to return 2 things for 3 states.</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="no">df</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/epi_slide.html">epi_slide</a></span>(<span class="kw">x_2dav</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="no">x</span>), <span class="fl">2</span>), <span class="kw">n</span> <span class="kw">=</span> <span class="fl">2</span>)</pre></body></html></div>
<pre><code>## Error in `Abort()`:
## ! If the slide computations return atomic vectors, then they must each
## have a single element, or else one element per appearance of the reference
## time value in the local window.</code></pre>
</div>
<div id="multi-column-outputs" class="section level2">
<h2 class="hasAnchor">
<a href="#multi-column-outputs" class="anchor"></a>Multi-column outputs</h2>
<p>Now we move on to outputs that are data frames with a single row but multiple columns. Working with this type of output structure has in fact has already been demonstrated in the <a href="https://cmu-delphi.github.io/epiprocess/articles/slide.html">slide vignette</a>. When we set <code>as_list_col = TRUE</code> in the call to <code><a href="../reference/epi_slide.html">epi_slide()</a></code>, the resulting <code>epi_df</code> object returned by <code><a href="../reference/epi_slide.html">epi_slide()</a></code> has a list column containing the slide values.</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="no">df2</span> <span class="kw">&lt;-</span> <span class="no">df</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(<span class="no">geo_value</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/epi_slide.html">epi_slide</a></span>(<span class="kw">a</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">x_2dav</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="no">x</span>), <span class="kw">x_2dma</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/mad.html">mad</a></span>(<span class="no">x</span>)),
            <span class="kw">n</span> <span class="kw">=</span> <span class="fl">2</span>, <span class="kw">as_list_col</span> <span class="kw">=</span> <span class="fl">TRUE</span>)

<span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span>(<span class="no">df2</span>$<span class="no">a</span>)</pre></body></html></div>
<pre><code>## [1] "list"</code></pre>
<div class="sourceCode" id="cb11"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">df2</span>$<span class="no">a</span>)</pre></body></html></div>
<pre><code>## [1] 9</code></pre>
<div class="sourceCode" id="cb13"><html><body><pre class="r"><span class="no">df2</span>$<span class="no">a</span><span class="kw">[[</span><span class="fl">2</span>]]</pre></body></html></div>
<pre><code>##     x_2dav    x_2dma
## 1 1.485707 0.7314287</code></pre>
<p>When we use <code>as_list_col = FALSE</code> (the default in <code><a href="../reference/epi_slide.html">epi_slide()</a></code>), the function unnests (in the sense of <code><a href="https://tidyr.tidyverse.org/reference/nest.html">tidyr::unnest()</a></code>) the list column <code>a</code>, so that the resulting <code>epi_df</code> has multiple new columns containing the slide values. The default is to name these unnested columns by prefixing the name assigned to the list column (here <code>a</code>) onto the column names of the output data frame from the slide computation (here <code>x_2dav</code> and <code>x_2dma</code>) separated by â€œ_â€œ.</p>
<div class="sourceCode" id="cb15"><html><body><pre class="r"><span class="no">df</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(<span class="no">geo_value</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/epi_slide.html">epi_slide</a></span>(<span class="kw">a</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">x_2dav</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="no">x</span>), <span class="kw">x_2dma</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/mad.html">mad</a></span>(<span class="no">x</span>)),
            <span class="kw">n</span> <span class="kw">=</span> <span class="fl">2</span>, <span class="kw">as_list_col</span> <span class="kw">=</span> <span class="fl">FALSE</span>)</pre></body></html></div>
<pre><code>## An `epi_df` object, with metadata:
## * geo_type  = state
## * time_type = day
## * as_of     = 2022-03-30 09:31:07
## 
## # A tibble: 9 Ã— 5
## # Groups:   geo_value [3]
##   geo_value time_value     x a_x_2dav a_x_2dma
## * &lt;chr&gt;     &lt;date&gt;     &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
## 1 ca        2020-06-01 0.992    0.992    0    
## 2 ca        2020-06-02 1.98     1.49     0.731
## 3 ca        2020-06-03 2.99     2.49     0.751
## 4 fl        2020-06-01 4.00     4.00     0    
## 5 fl        2020-06-02 5.00     4.50     0.743
## 6 fl        2020-06-03 6.00     5.50     0.746
## 7 pa        2020-06-01 7.00     7.00     0    
## 8 pa        2020-06-02 8.00     7.50     0.746
## 9 pa        2020-06-03 9.00     8.50     0.743</code></pre>
<p>We can use <code>names_sep = NULL</code> (which gets passed to <code><a href="https://tidyr.tidyverse.org/reference/nest.html">tidyr::unnest()</a></code>) to drop the prefix associated with list column name, in naming the unnested columns.</p>
<div class="sourceCode" id="cb17"><html><body><pre class="r"><span class="no">df</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(<span class="no">geo_value</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/epi_slide.html">epi_slide</a></span>(<span class="kw">a</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">x_2dav</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="no">x</span>), <span class="kw">x_2dma</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/mad.html">mad</a></span>(<span class="no">x</span>)),
            <span class="kw">n</span> <span class="kw">=</span> <span class="fl">2</span>, <span class="kw">as_list_col</span> <span class="kw">=</span> <span class="fl">FALSE</span>, <span class="kw">names_sep</span> <span class="kw">=</span> <span class="kw">NULL</span>)</pre></body></html></div>
<pre><code>## An `epi_df` object, with metadata:
## * geo_type  = state
## * time_type = day
## * as_of     = 2022-03-30 09:31:07
## 
## # A tibble: 9 Ã— 5
## # Groups:   geo_value [3]
##   geo_value time_value     x x_2dav x_2dma
## * &lt;chr&gt;     &lt;date&gt;     &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;
## 1 ca        2020-06-01 0.992  0.992  0    
## 2 ca        2020-06-02 1.98   1.49   0.731
## 3 ca        2020-06-03 2.99   2.49   0.751
## 4 fl        2020-06-01 4.00   4.00   0    
## 5 fl        2020-06-02 5.00   4.50   0.743
## 6 fl        2020-06-03 6.00   5.50   0.746
## 7 pa        2020-06-01 7.00   7.00   0    
## 8 pa        2020-06-02 8.00   7.50   0.746
## 9 pa        2020-06-03 9.00   8.50   0.743</code></pre>
<p>Furthermore, <code><a href="../reference/epi_slide.html">epi_slide()</a></code> will recycle the single row data frame as needed in order to make the result size stable, just like the case for atomic values.</p>
<div class="sourceCode" id="cb19"><html><body><pre class="r"><span class="no">df</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/epi_slide.html">epi_slide</a></span>(<span class="kw">a</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">x_2dav</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="no">x</span>), <span class="kw">x_2dma</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/mad.html">mad</a></span>(<span class="no">x</span>)),
            <span class="kw">n</span> <span class="kw">=</span> <span class="fl">2</span>, <span class="kw">as_list_col</span> <span class="kw">=</span> <span class="fl">FALSE</span>, <span class="kw">names_sep</span> <span class="kw">=</span> <span class="kw">NULL</span>)</pre></body></html></div>
<pre><code>## An `epi_df` object, with metadata:
## * geo_type  = state
## * time_type = day
## * as_of     = 2022-03-30 09:31:07
## 
## # A tibble: 9 Ã— 5
##   geo_value time_value     x x_2dav x_2dma
## * &lt;chr&gt;     &lt;date&gt;     &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;
## 1 ca        2020-06-01 0.992   3.99   4.45
## 2 fl        2020-06-01 4.00    3.99   4.45
## 3 pa        2020-06-01 7.00    3.99   4.45
## 4 ca        2020-06-02 1.98    4.49   3.72
## 5 fl        2020-06-02 5.00    4.49   3.72
## 6 pa        2020-06-02 8.00    4.49   3.72
## 7 ca        2020-06-03 2.99    5.50   3.71
## 8 fl        2020-06-03 6.00    5.50   3.71
## 9 pa        2020-06-03 9.00    5.50   3.71</code></pre>
</div>
<div id="multi-row-outputs" class="section level2">
<h2 class="hasAnchor">
<a href="#multi-row-outputs" class="anchor"></a>Multi-row outputs</h2>
<p>For a slide computation that outputs a data frame with more than one row, the behavior is analogous to a slide computation that outputs an atomic vector. Meaning, <code><a href="../reference/epi_slide.html">epi_slide()</a></code> will check that the result is size stable, and if so, will fill the new column(s) in the resulting <code>epi_df</code> object appropriately.</p>
<p>This can be convenient for modeling in the following sense: we can, for example, fit a sliding forecasting model by pooling data from different locations, and then return separate forecasts from this common model for each location. We use our synthetic example to demonstrate this idea abstractly but simply.</p>
<div class="sourceCode" id="cb21"><html><body><pre class="r"><span class="no">df</span>$<span class="no">y</span> <span class="kw">&lt;-</span> <span class="fl">2</span> * <span class="no">df</span>$<span class="no">x</span> + <span class="fl">0.05</span> * <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">df</span>$<span class="no">x</span>))

<span class="no">df</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/epi_slide.html">epi_slide</a></span>(<span class="kw">function</span>(<span class="no">d</span>, <span class="no">...</span>) {
    <span class="no">obj</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span>(<span class="no">y</span> ~ <span class="no">x</span>, <span class="kw">data</span> <span class="kw">=</span> <span class="no">d</span>)
    <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(
      <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span>(
        <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(<span class="no">obj</span>, <span class="kw">newdata</span> <span class="kw">=</span> <span class="no">d</span> <span class="kw">%&gt;%</span>
                  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(<span class="no">geo_value</span>) <span class="kw">%&gt;%</span>
                  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="no">time_value</span> <span class="kw">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="no">time_value</span>)),
                <span class="kw">interval</span> <span class="kw">=</span> <span class="st">"prediction"</span>, <span class="kw">level</span> <span class="kw">=</span> <span class="fl">0.9</span>)
      ))
  }, <span class="kw">n</span> <span class="kw">=</span> <span class="fl">2</span>, <span class="kw">new_col_name</span> <span class="kw">=</span> <span class="st">"fc"</span>, <span class="kw">names_sep</span> <span class="kw">=</span> <span class="kw">NULL</span>)</pre></body></html></div>
<pre><code>## An `epi_df` object, with metadata:
## * geo_type  = state
## * time_type = day
## * as_of     = 2022-03-30 09:31:07
## 
## # A tibble: 9 Ã— 7
##   geo_value time_value     x     y   fit   lwr   upr
## * &lt;chr&gt;     &lt;date&gt;     &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1 ca        2020-06-01 0.992  2.04  2.04  1.94  2.14
## 2 fl        2020-06-01 4.00   8.04  8.03  7.95  8.11
## 3 pa        2020-06-01 7.00  14.0  14.0  13.9  14.1 
## 4 ca        2020-06-02 1.98   3.93  3.98  3.89  4.06
## 5 fl        2020-06-02 5.00  10.0  10.0   9.94 10.1 
## 6 pa        2020-06-02 8.00  16.1  16.0  16.0  16.1 
## 7 ca        2020-06-03 2.99   6.00  5.98  5.92  6.04
## 8 fl        2020-06-03 6.00  12.0  12.0  12.0  12.1 
## 9 pa        2020-06-03 9.00  18.0  18.0  18.0  18.1</code></pre>
</div>
<div id="version-aware-forecasting-revisited" class="section level2">
<h2 class="hasAnchor">
<a href="#version-aware-forecasting-revisited" class="anchor"></a>Version-aware forecasting, revisited</h2>
<p>Finally, we revisit the COVID-19 forecasting example from the <a href="https://cmu-delphi.github.io/epiprocess/articles/slide.html">archive vignette</a> in order to demonstrate the last point in a more realistic setting. First, we fetch the versioned data and build the archive.</p>
<div class="sourceCode" id="cb23"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">delphi.epidata</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">data.table</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">ggplot2</span>)
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html">theme_set</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span>())

<span class="no">y1</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/delphi.epidata/man/covidcast.html">covidcast</a></span>(
  <span class="kw">data_source</span> <span class="kw">=</span> <span class="st">"doctor-visits"</span>,
  <span class="kw">signals</span> <span class="kw">=</span> <span class="st">"smoothed_adj_cli"</span>,
  <span class="kw">time_type</span> <span class="kw">=</span> <span class="st">"day"</span>,
  <span class="kw">geo_type</span> <span class="kw">=</span> <span class="st">"state"</span>,
  <span class="kw">time_value</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/delphi.epidata/man/epirange.html">epirange</a></span>(<span class="fl">20200601</span>, <span class="fl">20211201</span>),
  <span class="kw">geo_values</span> <span class="kw">=</span> <span class="st">"ca,fl"</span>,
  <span class="kw">issues</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/delphi.epidata/man/epirange.html">epirange</a></span>(<span class="fl">20200601</span>, <span class="fl">20211201</span>)
) <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/pkg/delphi.epidata/man/fetch_tbl.html">fetch_tbl</a></span>()

<span class="no">y2</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/delphi.epidata/man/covidcast.html">covidcast</a></span>(
  <span class="kw">data_source</span> <span class="kw">=</span> <span class="st">"jhu-csse"</span>,
  <span class="kw">signal</span> <span class="kw">=</span> <span class="st">"confirmed_7dav_incidence_prop"</span>,
  <span class="kw">time_type</span> <span class="kw">=</span> <span class="st">"day"</span>,
  <span class="kw">geo_type</span> <span class="kw">=</span> <span class="st">"state"</span>,
  <span class="kw">time_value</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/delphi.epidata/man/epirange.html">epirange</a></span>(<span class="fl">20200601</span>, <span class="fl">20211201</span>),
  <span class="kw">geo_values</span> <span class="kw">=</span> <span class="st">"ca,fl"</span>,
  <span class="kw">issues</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/delphi.epidata/man/epirange.html">epirange</a></span>(<span class="fl">20200601</span>, <span class="fl">20211201</span>)
) <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/pkg/delphi.epidata/man/fetch_tbl.html">fetch_tbl</a></span>()

<span class="no">x</span> <span class="kw">&lt;-</span> <span class="no">y1</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="no">geo_value</span>, <span class="no">time_value</span>,
    <span class="kw">version</span> <span class="kw">=</span> <span class="no">issue</span>,
    <span class="kw">percent_cli</span> <span class="kw">=</span> <span class="no">value</span>
  ) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/as_epi_archive.html">as_epi_archive</a></span>()

<span class="fu"><a href="../reference/epix_merge.html">epix_merge</a></span>(<span class="no">x</span>, <span class="no">y2</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="no">geo_value</span>, <span class="no">time_value</span>,
    <span class="kw">version</span> <span class="kw">=</span> <span class="no">issue</span>,
    <span class="kw">case_rate</span> <span class="kw">=</span> <span class="no">value</span>
  ) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/as_epi_archive.html">as_epi_archive</a></span>(),
<span class="kw">all</span> <span class="kw">=</span> <span class="fl">TRUE</span>
)</pre></body></html></div>
<p>Next, we extend the ARX function to handle multiple geo values, since in the present case, we will not be grouping by geo value and each slide computation will be run on multiple geo values at once. Note that, because <code><a href="../reference/epix_slide.html">epix_slide()</a></code> only returns the grouping variables, <code>time_value</code>, and the slide computations in the eventual returned tibble, we need to include <code>geo_value</code> as a column in the output data frame from our ARX computation.</p>
<div class="sourceCode" id="cb24"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">tidyr</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">purrr</span>)</pre></body></html></div>
<pre><code>## 
## Attaching package: 'purrr'</code></pre>
<pre><code>## The following object is masked from 'package:data.table':
## 
##     transpose</code></pre>
<div class="sourceCode" id="cb27"><html><body><pre class="r"><span class="no">prob_arx_args</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">lags</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>, <span class="fl">7</span>, <span class="fl">14</span>),
                          <span class="no">ahead</span> <span class="kw">=</span> <span class="fl">7</span>,
                          <span class="no">min_train_window</span> <span class="kw">=</span> <span class="fl">20</span>,
                          <span class="no">lower_level</span> <span class="kw">=</span> <span class="fl">0.05</span>,
                          <span class="no">upper_level</span> <span class="kw">=</span> <span class="fl">0.95</span>,
                          <span class="no">symmetrize</span> <span class="kw">=</span> <span class="fl">TRUE</span>,
                          <span class="no">intercept</span> <span class="kw">=</span> <span class="fl">FALSE</span>,
                          <span class="no">nonneg</span> <span class="kw">=</span> <span class="fl">TRUE</span>) {
  <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">lags</span> <span class="kw">=</span> <span class="no">lags</span>,
              <span class="kw">ahead</span> <span class="kw">=</span> <span class="no">ahead</span>,
              <span class="kw">min_train_window</span> <span class="kw">=</span> <span class="no">min_train_window</span>,
              <span class="kw">lower_level</span> <span class="kw">=</span> <span class="no">lower_level</span>,
              <span class="kw">upper_level</span> <span class="kw">=</span> <span class="no">upper_level</span>,
              <span class="kw">symmetrize</span> <span class="kw">=</span> <span class="no">symmetrize</span>,
              <span class="kw">intercept</span> <span class="kw">=</span> <span class="no">intercept</span>,
              <span class="kw">nonneg</span> <span class="kw">=</span> <span class="no">nonneg</span>))
}

<span class="no">prob_arx</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">x</span>, <span class="no">y</span>, <span class="no">geo_value</span>, <span class="no">time_value</span>, <span class="no">args</span> <span class="kw">=</span> <span class="fu">prob_arx_args</span>()) {
  <span class="co"># Return NA if insufficient training data</span>
  <span class="kw">if</span> (<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">y</span>) <span class="kw">&lt;</span> <span class="no">args</span>$<span class="no">min_train_window</span> + <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="no">args</span>$<span class="no">lags</span>) + <span class="no">args</span>$<span class="no">ahead</span>) {
    <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">geo_value</span> <span class="kw">=</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/duplicated.html">unique</a></span>(<span class="no">geo_value</span>), <span class="co"># Return geo value!</span>
                      <span class="kw">point</span> <span class="kw">=</span> <span class="fl">NA</span>, <span class="kw">lower</span> <span class="kw">=</span> <span class="fl">NA</span>, <span class="kw">upper</span> <span class="kw">=</span> <span class="fl">NA</span>))
  }

  <span class="co"># Set up x, y, lags list</span>
  <span class="kw">if</span> (!<span class="fu"><a href="https://rdrr.io/r/base/missing.html">missing</a></span>(<span class="no">x</span>)) <span class="no">x</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="no">x</span>, <span class="no">y</span>)
  <span class="kw">else</span> <span class="no">x</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="no">y</span>)
  <span class="kw">if</span> (!<span class="fu"><a href="https://rdrr.io/r/base/list.html">is.list</a></span>(<span class="no">args</span>$<span class="no">lags</span>)) <span class="no">args</span>$<span class="no">lags</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="no">args</span>$<span class="no">lags</span>)
  <span class="no">args</span>$<span class="no">lags</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="no">args</span>$<span class="no">lags</span>, <span class="kw">length.out</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span>(<span class="no">x</span>))

  <span class="co"># Build features and response for the AR model, and then fit it</span>
  <span class="no">dat</span> <span class="kw">&lt;-</span>
    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/reexports.html">tibble</a></span>(<span class="kw">i</span> <span class="kw">=</span> <span class="fl">1</span>:<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span>(<span class="no">x</span>), <span class="kw">lag</span> <span class="kw">=</span> <span class="no">args</span>$<span class="no">lags</span>) <span class="kw">%&gt;%</span>
    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span>(<span class="no">lag</span>) <span class="kw">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">name</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"x"</span>, <span class="fl">1</span>:<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">.</span>))) <span class="kw">%&gt;%</span>
    <span class="co"># One list element for each lagged feature</span>
    <span class="fu"><a href="https://purrr.tidyverse.org/reference/map2.html">pmap</a></span>(<span class="kw">function</span>(<span class="no">i</span>, <span class="no">lag</span>, <span class="no">name</span>) {
      <span class="fu"><a href="https://tidyr.tidyverse.org/reference/reexports.html">tibble</a></span>(<span class="kw">geo_value</span> <span class="kw">=</span> <span class="no">geo_value</span>,
             <span class="kw">time_value</span> <span class="kw">=</span> <span class="no">time_value</span> + <span class="no">lag</span>, <span class="co"># Shift back </span>
             !!<span class="no">name</span> <span class="kw">:=</span> <span class="no">x</span>[,<span class="no">i</span>])
    }) <span class="kw">%&gt;%</span>
    <span class="co"># One list element for the response vector</span>
    <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
      <span class="fu"><a href="https://tidyr.tidyverse.org/reference/reexports.html">tibble</a></span>(<span class="kw">geo_value</span> <span class="kw">=</span> <span class="no">geo_value</span>,
             <span class="kw">time_value</span> <span class="kw">=</span> <span class="no">time_value</span> - <span class="no">args</span>$<span class="no">ahead</span>, <span class="co"># Shift forward </span>
             <span class="kw">y</span> <span class="kw">=</span> <span class="no">y</span>))) <span class="kw">%&gt;%</span>
    <span class="co"># Combine them together into one data frame</span>
    <span class="fu"><a href="https://purrr.tidyverse.org/reference/reduce.html">reduce</a></span>(<span class="no">full_join</span>, <span class="kw">by</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"geo_value"</span>, <span class="st">"time_value"</span>)) <span class="kw">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span>(<span class="no">time_value</span>)
  <span class="kw">if</span> (<span class="no">args</span>$<span class="no">intercept</span>) <span class="no">dat</span>$<span class="no">x0</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">dat</span>))
  <span class="no">obj</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span>(<span class="no">y</span> ~ <span class="no">.</span> + <span class="fl">0</span>, <span class="kw">data</span> <span class="kw">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="no">dat</span>, -<span class="no">geo_value</span>, -<span class="no">time_value</span>))

  <span class="co"># Use LOCF to fill NAs in the latest feature values (do this by geo value)</span>
  <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setDT.html">setDT</a></span>(<span class="no">dat</span>) <span class="co"># Convert to a data.table object by reference</span>
  <span class="no">cols</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setops.html">setdiff</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="no">dat</span>), <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"geo_value"</span>, <span class="st">"time_value"</span>))
  <span class="no">dat</span>[, (<span class="no">cols</span>) <span class="kw">:=</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/nafill.html">nafill</a></span>(<span class="no">.SD</span>, <span class="kw">type</span> <span class="kw">=</span> <span class="st">"locf"</span>), <span class="kw">.SDcols</span> <span class="kw">=</span> <span class="no">cols</span>, <span class="kw">by</span> <span class="kw">=</span> <span class="st">"geo_value"</span>]

  <span class="co"># Make predictions</span>
  <span class="no">test_time_value</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="no">time_value</span>)
  <span class="no">point</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(<span class="no">obj</span>, <span class="kw">newdata</span> <span class="kw">=</span> <span class="no">dat</span> <span class="kw">%&gt;%</span>
                     <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(<span class="no">geo_value</span>) <span class="kw">%&gt;%</span>
                     <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="no">time_value</span> <span class="kw">==</span> <span class="no">test_time_value</span>))

  <span class="co"># Compute bands</span>
  <span class="no">r</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span>(<span class="no">obj</span>)
  <span class="no">s</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/fifelse.html">ifelse</a></span>(<span class="no">args</span>$<span class="no">symmetrize</span>, -<span class="fl">1</span>, <span class="fl">NA</span>) <span class="co"># Should the residuals be symmetrized?</span>
  <span class="no">q</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">r</span>, <span class="no">s</span> * <span class="no">r</span>), <span class="kw">probs</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">args</span>$<span class="no">lower</span>, <span class="no">args</span>$<span class="no">upper</span>), <span class="kw">na.rm</span> <span class="kw">=</span> <span class="fl">TRUE</span>)
  <span class="no">lower</span> <span class="kw">&lt;-</span> <span class="no">point</span> + <span class="no">q</span>[<span class="fl">1</span>]
  <span class="no">upper</span> <span class="kw">&lt;-</span> <span class="no">point</span> + <span class="no">q</span>[<span class="fl">2</span>]

  <span class="co"># Clip at zero if we need to, then return</span>
  <span class="kw">if</span> (<span class="no">args</span>$<span class="no">nonneg</span>) {
    <span class="no">point</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmax</a></span>(<span class="no">point</span>, <span class="fl">0</span>)
    <span class="no">lower</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmax</a></span>(<span class="no">lower</span>, <span class="fl">0</span>)
    <span class="no">upper</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmax</a></span>(<span class="no">upper</span>, <span class="fl">0</span>)
  }
  <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">geo_value</span> <span class="kw">=</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/duplicated.html">unique</a></span>(<span class="no">geo_value</span>), <span class="co"># Return geo value!</span>
                    <span class="kw">point</span> <span class="kw">=</span> <span class="no">point</span>, <span class="kw">lower</span> <span class="kw">=</span> <span class="no">lower</span>, <span class="kw">upper</span> <span class="kw">=</span> <span class="no">upper</span>))
}</pre></body></html></div>
<p>We now make forecasts on the archive and compare to forecasts on the latest data.</p>
<div class="sourceCode" id="cb28"><html><body><pre class="r"><span class="co"># Latest snapshot of data, and forecast dates</span>
<span class="no">x_latest</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/epix_as_of.html">epix_as_of</a></span>(<span class="no">x</span>, <span class="kw">max_version</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="no">x</span>$<span class="no">DT</span>$<span class="no">version</span>))
<span class="no">fc_time_values</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span>(<span class="st">"2020-08-01"</span>),
                      <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span>(<span class="st">"2021-12-01"</span>),
                      <span class="kw">by</span> <span class="kw">=</span> <span class="st">"1 month"</span>)

<span class="co"># Simple function to produce forecasts k weeks ahead</span>
<span class="no">k_week_ahead</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">x</span>, <span class="no">ahead</span> <span class="kw">=</span> <span class="fl">7</span>, <span class="no">as_of</span> <span class="kw">=</span> <span class="fl">TRUE</span>) {
  <span class="kw">if</span> (<span class="no">as_of</span>) {
    <span class="no">x</span> <span class="kw">%&gt;%</span>
      <span class="fu"><a href="../reference/epix_slide.html">epix_slide</a></span>(<span class="kw">fc</span> <span class="kw">=</span> <span class="fu">prob_arx</span>(<span class="no">percent_cli</span>, <span class="no">case_rate</span>, <span class="no">geo_value</span>, <span class="no">time_value</span>,
                               <span class="kw">args</span> <span class="kw">=</span> <span class="fu">prob_arx_args</span>(<span class="kw">ahead</span> <span class="kw">=</span> <span class="no">ahead</span>)),
                 <span class="kw">n</span> <span class="kw">=</span> <span class="fl">120</span>, <span class="kw">ref_time_values</span> <span class="kw">=</span> <span class="no">fc_time_values</span>) <span class="kw">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">target_date</span> <span class="kw">=</span> <span class="no">time_value</span> + <span class="no">ahead</span>, <span class="kw">as_of</span> <span class="kw">=</span> <span class="fl">TRUE</span>,
             <span class="kw">geo_value</span> <span class="kw">=</span> <span class="no">fc_geo_value</span>)
  }
  <span class="kw">else</span> {
    <span class="no">x_latest</span> <span class="kw">%&gt;%</span>
      <span class="fu"><a href="../reference/epi_slide.html">epi_slide</a></span>(<span class="kw">fc</span> <span class="kw">=</span> <span class="fu">prob_arx</span>(<span class="no">percent_cli</span>, <span class="no">case_rate</span>, <span class="no">geo_value</span>, <span class="no">time_value</span>,
                              <span class="kw">args</span> <span class="kw">=</span> <span class="fu">prob_arx_args</span>(<span class="kw">ahead</span> <span class="kw">=</span> <span class="no">ahead</span>)),
                <span class="kw">n</span> <span class="kw">=</span> <span class="fl">120</span>, <span class="kw">ref_time_values</span> <span class="kw">=</span> <span class="no">fc_time_values</span>) <span class="kw">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">target_date</span> <span class="kw">=</span> <span class="no">time_value</span> + <span class="no">ahead</span>, <span class="kw">as_of</span> <span class="kw">=</span> <span class="fl">FALSE</span>)
  }
}

<span class="co"># Generate the forecasts, and bind them together</span>
<span class="no">fc</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span>(<span class="fu">k_week_ahead</span>(<span class="no">x</span>, <span class="kw">ahead</span> <span class="kw">=</span> <span class="fl">7</span>, <span class="kw">as_of</span> <span class="kw">=</span> <span class="fl">TRUE</span>),
                <span class="fu">k_week_ahead</span>(<span class="no">x</span>, <span class="kw">ahead</span> <span class="kw">=</span> <span class="fl">14</span>, <span class="kw">as_of</span> <span class="kw">=</span> <span class="fl">TRUE</span>),
                <span class="fu">k_week_ahead</span>(<span class="no">x</span>, <span class="kw">ahead</span> <span class="kw">=</span> <span class="fl">21</span>, <span class="kw">as_of</span> <span class="kw">=</span> <span class="fl">TRUE</span>),
                <span class="fu">k_week_ahead</span>(<span class="no">x</span>, <span class="kw">ahead</span> <span class="kw">=</span> <span class="fl">28</span>, <span class="kw">as_of</span> <span class="kw">=</span> <span class="fl">TRUE</span>),
                <span class="fu">k_week_ahead</span>(<span class="no">x</span>, <span class="kw">ahead</span> <span class="kw">=</span> <span class="fl">7</span>, <span class="kw">as_of</span> <span class="kw">=</span> <span class="fl">FALSE</span>),
                <span class="fu">k_week_ahead</span>(<span class="no">x</span>, <span class="kw">ahead</span> <span class="kw">=</span> <span class="fl">14</span>, <span class="kw">as_of</span> <span class="kw">=</span> <span class="fl">FALSE</span>),
                <span class="fu">k_week_ahead</span>(<span class="no">x</span>, <span class="kw">ahead</span> <span class="kw">=</span> <span class="fl">21</span>, <span class="kw">as_of</span> <span class="kw">=</span> <span class="fl">FALSE</span>),
                <span class="fu">k_week_ahead</span>(<span class="no">x</span>, <span class="kw">ahead</span> <span class="kw">=</span> <span class="fl">28</span>, <span class="kw">as_of</span> <span class="kw">=</span> <span class="fl">FALSE</span>))

<span class="co"># Plot them, on top of latest COVID-19 case rates </span>
<span class="no">p</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="no">fc</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">target_date</span>, <span class="kw">group</span> <span class="kw">=</span> <span class="no">time_value</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="no">as_of</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">ymin</span> <span class="kw">=</span> <span class="no">fc_lower</span>, <span class="kw">ymax</span> <span class="kw">=</span> <span class="no">fc_upper</span>), <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.4</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">y</span> <span class="kw">=</span> <span class="no">fc_point</span>)) + <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">y</span> <span class="kw">=</span> <span class="no">fc_point</span>), <span class="kw">size</span> <span class="kw">=</span> <span class="fl">0.5</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">xintercept</span> <span class="kw">=</span> <span class="no">time_value</span>), <span class="kw">linetype</span> <span class="kw">=</span> <span class="fl">2</span>, <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.5</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html">facet_grid</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html">vars</a></span>(<span class="no">geo_value</span>), <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html">vars</a></span>(<span class="no">as_of</span>), <span class="kw">scales</span> <span class="kw">=</span> <span class="st">"free"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html">scale_x_date</a></span>(<span class="kw">minor_breaks</span> <span class="kw">=</span> <span class="st">"month"</span>, <span class="kw">date_labels</span> <span class="kw">=</span> <span class="st">"%b %y"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="st">"Date"</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="st">"Reported COVID-19 case rates"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="kw">legend.position</span> <span class="kw">=</span> <span class="st">"none"</span>)

<span class="kw pkg">gginnards</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/gginnards/man/delete_layers.html">append_layers</a></span>(
  <span class="no">p</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">x_latest</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">time_value</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">case_rate</span>),
               <span class="kw">inherit.aes</span> <span class="kw">=</span> <span class="fl">FALSE</span>, <span class="kw">color</span> <span class="kw">=</span> <span class="st">"gray50"</span>), <span class="kw">pos</span> <span class="kw">=</span> <span class="st">"bottom"</span>)</pre></body></html></div>
<p><img src="advanced_files/figure-html/unnamed-chunk-13-1.png" width="864"></p>
<p>We can see that these forecasts, which come from training an ARX model jointly over CA and FL, exhibit generally less variability and wider prediction bands compared to the ones from the archive vignette, which come from training a separate ARX model on each state. As in the archive vignette, we can see a difference between version-aware (right column) and -unaware (left column) forecasting, as well.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Logan Brooks, Evan Ray, Dmitry Shemetov, Ryan Tibshirani.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
