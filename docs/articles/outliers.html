<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>5. Detect and correct outliers in signals • epiprocess</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="5. Detect and correct outliers in signals">
<meta property="og:description" content="epiprocess">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">epiprocess</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/epiprocess.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/slide.html">1. Slide a computation over signal values</a>
    </li>
    <li>
      <a href="../articles/pct_change.html">2. Estimate growth rates in signals</a>
    </li>
    <li>
      <a href="../articles/correlation.html">3. Correlate signals over space and time</a>
    </li>
    <li>
      <a href="../articles/aggregation.html">4. Aggregate signals over space and time</a>
    </li>
    <li>
      <a href="../articles/outliers.html">5. Detect and correct outliers in signals</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/cmu-delphi/epiprocess/tree/main/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="outliers_files/header-attrs-2.10/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>5. Detect and correct outliers in signals</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/cmu-delphi/epiprocess/blob/main/vignettes/outliers.Rmd"><code>vignettes/outliers.Rmd</code></a></small>
      <div class="hidden name"><code>outliers.Rmd</code></div>

    </div>

    
    
<p>This vignette describes functionality for detecting and correcting outliers in signals in the <code><a href="../reference/epi_detect_outlr.html">epi_detect_outlr()</a></code> function provided in the <code>epiprocess</code> package. This is designed to be modular and extendable, so that you can provide your own outlier detection and correction functions and use them with <code>epi_df</code> objects. We’ll work with state-level daily reported COVID-19 case counts from Florida and New Jersey.</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">covidcast</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">epiprocess</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">dplyr</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">tidyr</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">ggplot2</span>)
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html">theme_set</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span>())

<span class="no">x</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/covidcast/man/covidcast_signal.html">covidcast_signal</a></span>(<span class="kw">data_source</span> <span class="kw">=</span> <span class="st">"jhu-csse"</span>,
                      <span class="kw">signal</span> <span class="kw">=</span> <span class="st">"confirmed_incidence_num"</span>,
                      <span class="kw">start_day</span> <span class="kw">=</span> <span class="st">"2020-06-01"</span>,
                      <span class="kw">end_day</span> <span class="kw">=</span> <span class="st">"2021-05-31"</span>,
                      <span class="kw">geo_type</span> <span class="kw">=</span> <span class="st">"state"</span>,
                      <span class="kw">geo_values</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"fl"</span>, <span class="st">"nj"</span>),
                      <span class="kw">as_of</span> <span class="kw">=</span> <span class="st">"2021-10-28"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="no">geo_value</span>, <span class="no">time_value</span>, <span class="kw">cases</span> <span class="kw">=</span> <span class="no">value</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/as_epi_df.html">as_epi_df</a></span>()

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="no">x</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">time_value</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">cases</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>() +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span>(<span class="kw">yintercept</span> <span class="kw">=</span> <span class="fl">0</span>, <span class="kw">linetype</span> <span class="kw">=</span> <span class="fl">3</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span>(<span class="fu"><a href="https://dplyr.tidyverse.org/reference/vars.html">vars</a></span>(<span class="no">geo_value</span>), <span class="kw">scales</span> <span class="kw">=</span> <span class="st">"free_y"</span>, <span class="kw">ncol</span> <span class="kw">=</span> <span class="fl">1</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html">scale_x_date</a></span>(<span class="kw">minor_breaks</span> <span class="kw">=</span> <span class="st">"month"</span>, <span class="kw">date_labels</span> <span class="kw">=</span> <span class="st">"%b %y"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="st">"Date"</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="st">"Reported COVID-19 counts"</span>)</pre></body></html></div>
<p><img src="outliers_files/figure-html/unnamed-chunk-1-1.png" width="768"></p>
<p>There are multiple outliers in these data that a modeler may want to detect and correct. We’ll discuss those two tasks in turn.</p>
<div id="outlier-detection" class="section level2">
<h2 class="hasAnchor">
<a href="#outlier-detection" class="anchor"></a>Outlier detection</h2>
<p>The <code><a href="../reference/epi_detect_outlr.html">epi_detect_outlr()</a></code> function allows us to run multiple outlier detection methods, and then (optionally) combine the results from those methods. Here, we’ll investigate outlier detection results from each of following methods.</p>
<ol style="list-style-type: decimal">
<li>Detection based on a rolling median, using <code><a href="../reference/epi_detect_outlr_rm.html">epi_detect_outlr_rm()</a></code>, which computes a rolling median on with a default window size of 21 time points centered at the time point under consideration, and then computes thresholds based on a multiplier times a rolling IQR computed on the residuals.</li>
<li>Detection based on a seasonal-trend decomposition using LOESS (STL), using <code><a href="../reference/epi_detect_outlr_stl.html">epi_detect_outlr_stl()</a></code>, which is similar to the rolling median method but replaces the rolling median with fitted values from STL.</li>
<li>Detection based on an STL decomposition, but without seasonality term, which amounts to smoothing using LOESS.</li>
</ol>
<p>The outlier detection methods are specified using a <code>tibble</code> that is passed to <code><a href="../reference/epi_detect_outlr.html">epi_detect_outlr()</a></code>, with one row per method, and whose columms specify the outlier detection function, any input arguments (only nondefault values need to be supplied), and an abbreviated name for the method used in tracking results. Abbreviations “rm” and “stl” can be used for the built-in detection functions <code><a href="../reference/epi_detect_outlr_rm.html">epi_detect_outlr_rm()</a></code> and <code><a href="../reference/epi_detect_outlr_stl.html">epi_detect_outlr_stl()</a></code>, respectively.</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="no">detection_methods</span> <span class="kw">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span>(
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/reexports.html">tibble</a></span>(<span class="kw">method</span> <span class="kw">=</span> <span class="st">"rm"</span>,
         <span class="kw">args</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">detect_negatives</span> <span class="kw">=</span> <span class="fl">TRUE</span>,
                          <span class="kw">detection_multiplier</span> <span class="kw">=</span> <span class="fl">2.5</span>)),
         <span class="kw">abbr</span> <span class="kw">=</span> <span class="st">"rm"</span>),
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/reexports.html">tibble</a></span>(<span class="kw">method</span> <span class="kw">=</span> <span class="st">"stl"</span>,
         <span class="kw">args</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">detect_negatives</span> <span class="kw">=</span> <span class="fl">TRUE</span>,
                          <span class="kw">detection_multiplier</span> <span class="kw">=</span> <span class="fl">2.5</span>)),
         <span class="kw">abbr</span> <span class="kw">=</span> <span class="st">"stl_seasonal"</span>),
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/reexports.html">tibble</a></span>(<span class="kw">method</span> <span class="kw">=</span> <span class="st">"stl"</span>,
         <span class="kw">args</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">detect_negatives</span> <span class="kw">=</span> <span class="fl">TRUE</span>,
                          <span class="kw">detection_multiplier</span> <span class="kw">=</span> <span class="fl">2.5</span>,
                          <span class="kw">seasonal_period</span> <span class="kw">=</span> <span class="kw">NULL</span>)),
         <span class="kw">abbr</span> <span class="kw">=</span> <span class="st">"stl_nonseasonal"</span>))

<span class="no">detection_methods</span></pre></body></html></div>
<pre><code>## # A tibble: 3 × 3
##   method args             abbr           
##   &lt;chr&gt;  &lt;list&gt;           &lt;chr&gt;          
## 1 rm     &lt;named list [2]&gt; rm             
## 2 stl    &lt;named list [2]&gt; stl_seasonal   
## 3 stl    &lt;named list [3]&gt; stl_nonseasonal</code></pre>
<p>Additionally, we’ll form combined lower and upper thresholds, calculated as the median of the lower and upper thresholds from the methods at each time point. Note that using this combined median threshold is equivalent to using a majority vote across the base methods to determine whether a value is an outlier.</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="no">x</span> <span class="kw">&lt;-</span> <span class="no">x</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(<span class="no">geo_value</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/epi_detect_outlr.html">epi_detect_outlr</a></span>(
    <span class="kw">var</span> <span class="kw">=</span> <span class="no">cases</span>,
    <span class="kw">methods</span> <span class="kw">=</span> <span class="no">detection_methods</span>,
    <span class="kw">combiner</span> <span class="kw">=</span> <span class="st">"median"</span>,
    <span class="kw">new_col_name</span> <span class="kw">=</span> <span class="st">"outlier_info"</span>)</pre></body></html></div>
<p>We can see that <code>x</code> has now been updated to include a new column <code>outlier_info</code> with information about the detection thresholds and possible replacement values from each method.</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">x</span>)</pre></body></html></div>
<pre><code>## # A tibble: 6 × 4
##   geo_value time_value cases outlier_info     
##   &lt;chr&gt;     &lt;date&gt;     &lt;dbl&gt; &lt;list&gt;           
## 1 fl        2020-06-01   667 &lt;tibble [1 × 12]&gt;
## 2 fl        2020-06-02   617 &lt;tibble [1 × 12]&gt;
## 3 fl        2020-06-03  1317 &lt;tibble [1 × 12]&gt;
## 4 fl        2020-06-04  1419 &lt;tibble [1 × 12]&gt;
## 5 fl        2020-06-05  1305 &lt;tibble [1 × 12]&gt;
## 6 fl        2020-06-06  1270 &lt;tibble [1 × 12]&gt;</code></pre>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">x</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span>(<span class="no">outlier_info</span>))</pre></body></html></div>
<pre><code>## # A tibble: 6 × 15
##   geo_value time_value cases rm_lower rm_upper rm_replacement stl_seasonal_lower
##   &lt;chr&gt;     &lt;date&gt;     &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;          &lt;dbl&gt;              &lt;dbl&gt;
## 1 fl        2020-06-01   667     345     2195             667               10.5
## 2 fl        2020-06-02   617     406.    2169.            617              201. 
## 3 fl        2020-06-03  1317     468.    2142.           1317               90.5
## 4 fl        2020-06-04  1419     564.    2058.           1419              269. 
## 5 fl        2020-06-05  1305     362     2272            1305              329. 
## 6 fl        2020-06-06  1270     380.    2308.           1270              261. 
## # … with 8 more variables: stl_seasonal_upper &lt;dbl&gt;,
## #   stl_seasonal_replacement &lt;dbl&gt;, stl_nonseasonal_lower &lt;dbl&gt;,
## #   stl_nonseasonal_upper &lt;dbl&gt;, stl_nonseasonal_replacement &lt;dbl&gt;,
## #   combined_lower &lt;dbl&gt;, combined_upper &lt;dbl&gt;, combined_replacement &lt;dbl&gt;</code></pre>
<p>To visualize the results, we first define a convenience function for plotting.</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="co"># Plot outlier detection bands and/or points identified as outliers</span>
<span class="no">plot_outliers</span> <span class="kw">=</span> <span class="kw">function</span>(<span class="no">x</span>, <span class="no">var</span>, <span class="no">outliers_col</span> <span class="kw">=</span> <span class="no">outlier_info</span>,
                         <span class="no">bands</span> <span class="kw">=</span> <span class="fl">FALSE</span>, <span class="no">points</span> <span class="kw">=</span> <span class="fl">TRUE</span>, <span class="no">combined_only</span> <span class="kw">=</span> <span class="fl">TRUE</span>,
                         <span class="no">facet_vars</span> <span class="kw">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/vars.html">vars</a></span>(<span class="no">geo_value</span>), <span class="no">nrow</span> <span class="kw">=</span> <span class="kw">NULL</span>, <span class="no">ncol</span> <span class="kw">=</span> <span class="kw">NULL</span>,
                         <span class="no">scales</span> <span class="kw">=</span> <span class="st">"fixed"</span>) {
  <span class="no">var</span> <span class="kw">&lt;-</span> <span class="kw pkg">rlang</span><span class="kw ns">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/nse-defuse.html">enquo</a></span>(<span class="no">var</span>)
  <span class="no">outliers_col</span> <span class="kw">&lt;-</span> <span class="kw pkg">rlang</span><span class="kw ns">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/nse-defuse.html">enquo</a></span>(<span class="no">outliers_col</span>)

  <span class="co"># Convert outlier detection results to long format </span>
  <span class="no">x_long</span> <span class="kw">&lt;-</span> <span class="no">x</span> <span class="kw">%&gt;%</span>
    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span>(!!<span class="no">outliers_col</span>) <span class="kw">%&gt;%</span>
    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span>(
      <span class="kw">cols</span> <span class="kw">=</span> <span class="no">x</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span>(!!<span class="no">outliers_col</span>) <span class="kw">%&gt;%</span> <span class="fu">`[[`</span>(<span class="fl">1</span>) <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(),
      <span class="kw">names_to</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"method"</span>, <span class="st">".value"</span>),
      <span class="kw">names_pattern</span> <span class="kw">=</span> <span class="st">"(.+)_(.+)"</span>)

  <span class="co"># If requested, filter to only combined method</span>
  <span class="kw">if</span> (<span class="no">combined_only</span>) <span class="no">x_long</span> <span class="kw">&lt;-</span> <span class="no">x_long</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="no">method</span> <span class="kw">==</span> <span class="st">"combined"</span>)

  <span class="co"># Start of plot with observed data</span>
  <span class="no">p</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>() +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">x</span>, <span class="kw">mapping</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">time_value</span>, <span class="kw">y</span> <span class="kw">=</span> !!<span class="no">var</span>))

  <span class="co"># If requested, add bands</span>
  <span class="kw">if</span> (<span class="no">bands</span>)
    <span class="no">p</span> <span class="kw">&lt;-</span> <span class="no">p</span> + <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">x_long</span>,
                         <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">time_value</span>, <span class="kw">ymin</span> <span class="kw">=</span> <span class="no">lower</span>, <span class="kw">ymax</span> <span class="kw">=</span> <span class="no">upper</span>,
                             <span class="kw">color</span> <span class="kw">=</span> <span class="no">method</span>), <span class="kw">fill</span> <span class="kw">=</span> <span class="fl">NA</span>)

  <span class="co"># If requested, add points</span>
  <span class="kw">if</span> (<span class="no">points</span>) {
    <span class="no">x_detected</span> <span class="kw">&lt;-</span> <span class="no">x_long</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>((!!<span class="no">var</span> <span class="kw">&lt;</span> <span class="no">lower</span>) <span class="kw">|</span> (!!<span class="no">var</span> <span class="kw">&gt;</span> <span class="no">upper</span>))
    <span class="no">p</span> <span class="kw">&lt;-</span> <span class="no">p</span> + <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">x_detected</span>,
                        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">time_value</span>, <span class="kw">y</span> <span class="kw">=</span> !!<span class="no">var</span>, <span class="kw">color</span> <span class="kw">=</span> <span class="no">method</span>,
                            <span class="kw">shape</span> <span class="kw">=</span> <span class="no">method</span>))
  }

  <span class="co"># If requested, add faceting</span>
  <span class="kw">if</span> (!<span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span>(<span class="no">facet_vars</span>))
    <span class="no">p</span> <span class="kw">&lt;-</span> <span class="no">p</span> + <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span>(<span class="no">facet_vars</span>, <span class="kw">nrow</span> <span class="kw">=</span> <span class="no">nrow</span>, <span class="kw">ncol</span> <span class="kw">=</span> <span class="no">ncol</span>, <span class="kw">scales</span> <span class="kw">=</span> <span class="no">scales</span>)

  <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="no">p</span>)
}</pre></body></html></div>
<p>Now we produce plots for each state at a time, faceting by the detection method.</p>
<div class="sourceCode" id="cb10"><html><body><pre class="r"><span class="fu">plot_outliers</span>(<span class="no">x</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="no">geo_value</span> <span class="kw">==</span> <span class="st">"fl"</span>), <span class="no">cases</span>,
              <span class="kw">bands</span> <span class="kw">=</span> <span class="fl">TRUE</span>, <span class="kw">combined_only</span> <span class="kw">=</span> <span class="fl">FALSE</span>,
              <span class="kw">facet_vars</span> <span class="kw">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/vars.html">vars</a></span>(<span class="no">method</span>), <span class="kw">scales</span> <span class="kw">=</span> <span class="st">"free_y"</span>, <span class="kw">ncol</span> <span class="kw">=</span> <span class="fl">1</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html">scale_x_date</a></span>(<span class="kw">minor_breaks</span> <span class="kw">=</span> <span class="st">"month"</span>, <span class="kw">date_labels</span> <span class="kw">=</span> <span class="st">"%b %y"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="st">"Date"</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="st">"Reported COVID-19 counts"</span>)</pre></body></html></div>
<p><img src="outliers_files/figure-html/unnamed-chunk-6-1.png" width="864"></p>
<div class="sourceCode" id="cb11"><html><body><pre class="r"><span class="fu">plot_outliers</span>(<span class="no">x</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="no">geo_value</span> <span class="kw">==</span> <span class="st">"nj"</span>), <span class="no">cases</span>,
              <span class="kw">bands</span> <span class="kw">=</span> <span class="fl">TRUE</span>, <span class="kw">combined_only</span> <span class="kw">=</span> <span class="fl">FALSE</span>,
              <span class="kw">facet_vars</span> <span class="kw">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/vars.html">vars</a></span>(<span class="no">method</span>), <span class="kw">scales</span> <span class="kw">=</span> <span class="st">"free_y"</span>, <span class="kw">ncol</span> <span class="kw">=</span> <span class="fl">1</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html">scale_x_date</a></span>(<span class="kw">minor_breaks</span> <span class="kw">=</span> <span class="st">"month"</span>, <span class="kw">date_labels</span> <span class="kw">=</span> <span class="st">"%b %y"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="st">"Date"</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="st">"Reported COVID-19 counts"</span>)</pre></body></html></div>
<p><img src="outliers_files/figure-html/unnamed-chunk-6-2.png" width="864"></p>
</div>
<div id="outlier-correction" class="section level2">
<h2 class="hasAnchor">
<a href="#outlier-correction" class="anchor"></a>Outlier correction</h2>
<p>Finally, in order to correct outliers, we can use the posited replacement values returned by each outlier detection method. Below we use the replacement value from the combined method, which is defined by the median of replacement values from the base methods at each time point.</p>
<div class="sourceCode" id="cb12"><html><body><pre class="r"><span class="no">y</span> <span class="kw">&lt;-</span> <span class="no">x</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span>(<span class="no">outlier_info</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">cases_corrected</span> <span class="kw">=</span> <span class="no">combined_replacement</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="no">geo_value</span>, <span class="no">time_value</span>, <span class="no">cases</span>, <span class="no">cases_corrected</span>)

<span class="no">y</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="no">cases</span> <span class="kw">!=</span> <span class="no">cases_corrected</span>)</pre></body></html></div>
<pre><code>## # A tibble: 20 × 4
## # Groups:   geo_value [2]
##    geo_value time_value cases cases_corrected
##    &lt;chr&gt;     &lt;date&gt;     &lt;dbl&gt;           &lt;dbl&gt;
##  1 fl        2020-07-12 15300           9165.
##  2 fl        2020-09-01  7569           2861.
##  3 fl        2020-10-10     0           2643.
##  4 fl        2020-10-11  5570           2699.
##  5 fl        2020-11-26     0           8435.
##  6 fl        2020-11-27 17344           8553.
##  7 fl        2020-12-25     0          11905.
##  8 fl        2021-01-02 31518          12849.
##  9 fl        2021-03-01  1700           5378.
## 10 fl        2021-04-12  1613           6157.
## 11 nj        2020-07-19    -8            320.
## 12 nj        2020-08-13   694            404.
## 13 nj        2020-08-14   619            397.
## 14 nj        2020-08-16    40            379.
## 15 nj        2020-08-22   555            329.
## 16 nj        2020-10-08  1415            873.
## 17 nj        2020-10-19  1807           1262.
## 18 nj        2021-02-15  1445           3454.
## 19 nj        2021-04-26 -9005           2193.
## 20 nj        2021-05-08  -221            904.</code></pre>
<div class="sourceCode" id="cb14"><html><body><pre class="r"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="no">y</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">time_value</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">y</span> <span class="kw">=</span> <span class="no">cases</span>), <span class="kw">linetype</span> <span class="kw">=</span> <span class="fl">2</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">y</span> <span class="kw">=</span> <span class="no">cases_corrected</span>), <span class="kw">col</span> <span class="kw">=</span> <span class="st">"red"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span>(<span class="kw">yintercept</span> <span class="kw">=</span> <span class="fl">0</span>, <span class="kw">linetype</span> <span class="kw">=</span> <span class="fl">3</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span>(<span class="fu"><a href="https://dplyr.tidyverse.org/reference/vars.html">vars</a></span>(<span class="no">geo_value</span>), <span class="kw">scales</span> <span class="kw">=</span> <span class="st">"free_y"</span>, <span class="kw">ncol</span> <span class="kw">=</span> <span class="fl">1</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html">scale_x_date</a></span>(<span class="kw">minor_breaks</span> <span class="kw">=</span> <span class="st">"month"</span>, <span class="kw">date_labels</span> <span class="kw">=</span> <span class="st">"%b %y"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="st">"Date"</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="st">"Reported COVID-19 counts"</span>)</pre></body></html></div>
<p><img src="outliers_files/figure-html/unnamed-chunk-7-1.png" width="768"></p>
<p>More advanced correction functionality will be coming at some point in the future.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Logan Brooks, Evan Ray, Ryan Tibshirani.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
