<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>1. Slide a computation over signal values • epitools</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="1. Slide a computation over signal values">
<meta property="og:description" content="Slide a computation signal values over time.">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">epitools</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/epitools.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/slide.html">1. Slide a computation over signal values</a>
    </li>
    <li>
      <a href="../articles/pct-change.html">2. Compute percentage change over time</a>
    </li>
    <li>
      <a href="../articles/derivatives.html">3. Estimate derivatives of signals</a>
    </li>
    <li>
      <a href="../articles/correlations.html">4. Compute correlations between signals</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/cmu-delphi/epitools/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="slide_files/header-attrs-2.10/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>1. Slide a computation over signal values</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/cmu-delphi/epitools/vignettes/slide.Rmd"><code>vignettes/slide.Rmd</code></a></small>
      <div class="hidden name"><code>slide.Rmd</code></div>

    </div>

    
    
<p>One of the most basic tools in the <code>epitools</code> package is <code><a href="../reference/slide_by_geo.html">slide_by_geo()</a></code>, which is based on the family of functions provided by the <a href="https://cran.r-project.org/web/packages/slider/"><code>slider</code></a> package. In <code>epitools</code>, to “slide” means to apply a computation—represented as a function or formula—over a trailing window of <code>n</code> days of data, grouped by <code>geo_value</code>. Several other functions in the <code>epitools</code> package, such as <code><a href="../reference/pct_change.html">pct_change()</a></code> and <code><a href="../reference/estimate_deriv.html">estimate_deriv()</a></code>, use <code><a href="../reference/slide_by_geo.html">slide_by_geo()</a></code> as their workhorse.</p>
<p>Similar to the getting started guide, we’ll fetch daily reported COVID-19 cases for a few U.S. states (note: new, not cumulative cases) using the <a href="https://cmu-delphi.github.io/covidcast/covidcastR/"><code>covidcast</code></a> package, and then convert this to <code>epi_signal</code> format.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://cmu-delphi.github.io/covidcast/covidcastR/">covidcast</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">epitools</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>

<span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://cmu-delphi.github.io/covidcast/covidcastR/reference/covidcast_signal.html">covidcast_signal</a></span><span class="op">(</span>data_source <span class="op">=</span> <span class="st">"jhu-csse"</span>, 
                      signal <span class="op">=</span> <span class="st">"confirmed_incidence_num"</span>,
                      start_day <span class="op">=</span> <span class="st">"2020-06-01"</span>, 
                      end_day <span class="op">=</span> <span class="st">"2021-05-31"</span>,
                      geo_type <span class="op">=</span> <span class="st">"state"</span>, 
                      geo_values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ca"</span>, <span class="st">"fl"</span>, <span class="st">"ny"</span>, <span class="st">"tx"</span><span class="op">)</span><span class="op">)</span>  <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/as.epi_signal.html">as.epi_signal</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"covid19_cases"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">value</span>, <span class="va">geo_value</span>, <span class="va">time_value</span>, <span class="va">issue</span><span class="op">)</span></code></pre></div>
<div id="slide-with-a-formula" class="section level2">
<h2 class="hasAnchor">
<a href="#slide-with-a-formula" class="anchor"></a>Slide with a formula</h2>
<p>We first demonstrate how to apply a 7-day trailing average to the daily counts in order to smooth the signal, by using a formula in the <code>slide_fun</code> argument of <code><a href="../reference/slide_by_geo.html">slide_by_geo()</a></code>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/slide_by_geo.html">slide_by_geo</a></span><span class="op">(</span><span class="va">x</span>, slide_fun <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="../reference/Min.html">Mean</a></span><span class="op">(</span><span class="va">.x</span><span class="op">$</span><span class="va">value</span><span class="op">)</span>, n <span class="op">=</span> <span class="fl">7</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 10 × 5
##    value geo_value time_value issue      slide_value
##    &lt;dbl&gt; &lt;chr&gt;     &lt;date&gt;     &lt;date&gt;           &lt;dbl&gt;
##  1  2360 ca        2020-06-01 2021-09-27       2360 
##  2  2372 ca        2020-06-02 2021-09-16       2366 
##  3  2214 ca        2020-06-03 2021-09-16       2315.
##  4  3011 ca        2020-06-04 2021-09-16       2489.
##  5  3025 ca        2020-06-05 2021-09-27       2596.
##  6  3046 ca        2020-06-06 2021-09-16       2671.
##  7  2404 ca        2020-06-07 2021-09-16       2633.
##  8  2385 ca        2020-06-08 2021-09-27       2637.
##  9  2700 ca        2020-06-09 2021-09-16       2684.
## 10  3208 ca        2020-06-10 2021-09-16       2826.</code></pre>
<p>The formula specified via <code>slide_fun</code> has access to all columns present in the original <code>epi_signal</code> data frame, and must refer to them with the prefix <code>.x$</code>. Here the function <code><a href="../reference/Min.html">Mean()</a></code> is a simple wrapper around <code><a href="https://rdrr.io/r/base/mean.html">mean()</a></code> that omits <code>NA</code> values by default (provided by the <code>epitools</code> package).</p>
<p>Notice that <code><a href="../reference/slide_by_geo.html">slide_by_geo()</a></code> returns a data frame with a new column appended that contains the results (from sliding the formula), named <code>slide_value</code> by default. We can instead specify a name up front using the <code>col_name</code> argument:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/slide_by_geo.html">slide_by_geo</a></span><span class="op">(</span><span class="va">x</span>, slide_fun <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="../reference/Min.html">Mean</a></span><span class="op">(</span><span class="va">.x</span><span class="op">$</span><span class="va">value</span><span class="op">)</span>, n <span class="op">=</span> <span class="fl">7</span>, col_name <span class="op">=</span> <span class="st">"7dav"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 10 × 5
##    value geo_value time_value issue      `7dav`
##    &lt;dbl&gt; &lt;chr&gt;     &lt;date&gt;     &lt;date&gt;      &lt;dbl&gt;
##  1  2360 ca        2020-06-01 2021-09-27  2360 
##  2  2372 ca        2020-06-02 2021-09-16  2366 
##  3  2214 ca        2020-06-03 2021-09-16  2315.
##  4  3011 ca        2020-06-04 2021-09-16  2489.
##  5  3025 ca        2020-06-05 2021-09-27  2596.
##  6  3046 ca        2020-06-06 2021-09-16  2671.
##  7  2404 ca        2020-06-07 2021-09-16  2633.
##  8  2385 ca        2020-06-08 2021-09-27  2637.
##  9  2700 ca        2020-06-09 2021-09-16  2684.
## 10  3208 ca        2020-06-10 2021-09-16  2826.</code></pre>
<p>As a simple sanity check, we visualize the 7-day trailing averages computed on top of the original counts:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html">theme_set</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="../reference/slide_by_geo.html">slide_by_geo</a></span><span class="op">(</span><span class="va">x</span>, slide_fun <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="../reference/Min.html">Mean</a></span><span class="op">(</span><span class="va">.x</span><span class="op">$</span><span class="va">value</span><span class="op">)</span>, n <span class="op">=</span> <span class="fl">7</span>, col_name <span class="op">=</span> <span class="st">"7dav"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time_value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_col</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">value</span>, fill <span class="op">=</span> <span class="va">geo_value</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">`7dav`</span>, col <span class="op">=</span> <span class="va">geo_value</span><span class="op">)</span>, show.legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span> <span class="va">geo_value</span>, scales <span class="op">=</span> <span class="st">"free_y"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html">scale_x_date</a></span><span class="op">(</span>minor_breaks <span class="op">=</span> <span class="st">"month"</span>, date_labels <span class="op">=</span> <span class="st">"%b %y"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Date"</span>, y <span class="op">=</span> <span class="st">"Reported COVID-19 cases"</span>, fill <span class="op">=</span> <span class="st">"State"</span><span class="op">)</span></code></pre></div>
<p><img src="slide_files/figure-html/unnamed-chunk-4-1.png" width="864"></p>
</div>
<div id="slide-with-a-function" class="section level2">
<h2 class="hasAnchor">
<a href="#slide-with-a-function" class="anchor"></a>Slide with a function</h2>
<p>We can also pass a function for the <code>slide_fun</code> argument in <code><a href="../reference/slide_by_geo.html">slide_by_geo()</a></code>. In this case, the passed function must have the following argument structure: <code>x</code>, a data frame the same column names as the original data frame; followed by any number of named additional arguments; and ending with <code>...</code>, to capture general additional arguments. Recreating the last example of a 7-day trailing average:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/slide_by_geo.html">slide_by_geo</a></span><span class="op">(</span><span class="va">x</span>, slide_fun <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="fu"><a href="../reference/Min.html">Mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">value</span><span class="op">)</span>, n <span class="op">=</span> <span class="fl">7</span>,
             col_name <span class="op">=</span> <span class="st">"7dav"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 10 × 5
##    value geo_value time_value issue      `7dav`
##    &lt;dbl&gt; &lt;chr&gt;     &lt;date&gt;     &lt;date&gt;      &lt;dbl&gt;
##  1  2360 ca        2020-06-01 2021-09-27  2360 
##  2  2372 ca        2020-06-02 2021-09-16  2366 
##  3  2214 ca        2020-06-03 2021-09-16  2315.
##  4  3011 ca        2020-06-04 2021-09-16  2489.
##  5  3025 ca        2020-06-05 2021-09-27  2596.
##  6  3046 ca        2020-06-06 2021-09-16  2671.
##  7  2404 ca        2020-06-07 2021-09-16  2633.
##  8  2385 ca        2020-06-08 2021-09-27  2637.
##  9  2700 ca        2020-06-09 2021-09-16  2684.
## 10  3208 ca        2020-06-10 2021-09-16  2826.</code></pre>
<p>As a more complicated example, we recreate two “local” forecasters. Simple versions of these can be built using the <a href="https://tsibble.tidyverts.org"><code>{tsibble}</code> package</a>, but here we also generate prediction intervals in addition to the point forecasts. The first is a simple “baseline” forecaster which propagates a flat line forward, and uses the residuals to create quantiles. The result will be a data frame with one column containing the desired quantiles, and the other containing the predicted values at those quantiles.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">local_baseline</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">ahead</span> <span class="op">=</span> <span class="fl">1</span>, <span class="va">min_train_window</span> <span class="op">=</span> <span class="fl">25</span>,
                           <span class="va">quantile_levels</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.9</span><span class="op">)</span>, 
                           <span class="va">symmetrize</span> <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">ahead</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">ahead</span><span class="op">)</span> <span class="co"># how many units of time ahead do we predict</span>
  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">&lt;</span> <span class="va">min_train_window</span> <span class="op">+</span> <span class="va">ahead</span><span class="op">)</span> 
    <span class="co"># return NA forecasts if insufficient data</span>
    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>value <span class="op">=</span> <span class="cn">NA</span>, quantile <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="va">quantile_levels</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html">stopifnot</a></span><span class="op">(</span><span class="va">ahead</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span>
  <span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">symmetrize</span>, <span class="op">-</span><span class="fl">1</span>, <span class="cn">NA</span><span class="op">)</span> <span class="co"># should the PIs be symmetric?</span>
  <span class="va">point</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">tail</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">1</span><span class="op">)</span> <span class="co"># the point forecast is the most recent value</span>
  <span class="va">resids</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op">-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">ahead</span><span class="op">)</span>
  <span class="va">resids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">resids</span>, <span class="va">s</span> <span class="op">*</span> <span class="va">resids</span><span class="op">)</span>
  <span class="va">q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">resids</span>, probs <span class="op">=</span> <span class="va">quantile_levels</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>value <span class="op">=</span> <span class="va">q</span> <span class="op">+</span> <span class="va">point</span>, quantile <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="va">quantile_levels</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">baseline_fcasts</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="../reference/slide_by_geo.html">slide_by_geo</a></span><span class="op">(</span>slide_fun <span class="op">=</span> <span class="op">~</span> <span class="fu">local_baseline</span><span class="op">(</span><span class="va">.x</span><span class="op">$</span><span class="va">value</span><span class="op">)</span>, 
               n <span class="op">=</span> <span class="fl">100</span>, col_type <span class="op">=</span> <span class="st">"list"</span>, col_name <span class="op">=</span> <span class="st">"value"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>forecast_date <span class="op">=</span> <span class="va">time_value</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>target_date <span class="op">=</span> <span class="va">forecast_date</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co"># forecast 1 day ahead</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">issue</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">baseline_fcasts</span>, <span class="fl">10</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 10 × 4
##    value        geo_value forecast_date target_date
##    &lt;list&gt;       &lt;chr&gt;     &lt;date&gt;        &lt;date&gt;     
##  1 &lt;df [3 × 2]&gt; ca        2020-06-01    2020-06-02 
##  2 &lt;df [3 × 2]&gt; ca        2020-06-02    2020-06-03 
##  3 &lt;df [3 × 2]&gt; ca        2020-06-03    2020-06-04 
##  4 &lt;df [3 × 2]&gt; ca        2020-06-04    2020-06-05 
##  5 &lt;df [3 × 2]&gt; ca        2020-06-05    2020-06-06 
##  6 &lt;df [3 × 2]&gt; ca        2020-06-06    2020-06-07 
##  7 &lt;df [3 × 2]&gt; ca        2020-06-07    2020-06-08 
##  8 &lt;df [3 × 2]&gt; ca        2020-06-08    2020-06-09 
##  9 &lt;df [3 × 2]&gt; ca        2020-06-09    2020-06-10 
## 10 &lt;df [3 × 2]&gt; ca        2020-06-10    2020-06-11</code></pre>
<p>Note the <code>col_type = "list"</code> argument is required here. To convert to a “long” <code>tibble</code>, we can unnest the result.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org">tidyr</a></span><span class="op">)</span>
<span class="va">baseline_fcasts</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">tail</a></span><span class="op">(</span><span class="fl">20</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 20 × 5
##      value quantile geo_value forecast_date target_date
##      &lt;dbl&gt;    &lt;dbl&gt; &lt;chr&gt;     &lt;date&gt;        &lt;date&gt;     
##  1   405.       0.1 tx        2021-05-25    2021-05-26 
##  2  4651.       0.9 tx        2021-05-25    2021-05-26 
##  3  2193       NA   tx        2021-05-26    2021-05-27 
##  4    70.4      0.1 tx        2021-05-26    2021-05-27 
##  5  4316.       0.9 tx        2021-05-26    2021-05-27 
##  6  1601       NA   tx        2021-05-27    2021-05-28 
##  7  -490.       0.1 tx        2021-05-27    2021-05-28 
##  8  3692.       0.9 tx        2021-05-27    2021-05-28 
##  9  1724       NA   tx        2021-05-28    2021-05-29 
## 10  -339.       0.1 tx        2021-05-28    2021-05-29 
## 11  3787.       0.9 tx        2021-05-28    2021-05-29 
## 12   550       NA   tx        2021-05-29    2021-05-30 
## 13 -1377.       0.1 tx        2021-05-29    2021-05-30 
## 14  2477.       0.9 tx        2021-05-29    2021-05-30 
## 15   374       NA   tx        2021-05-30    2021-05-31 
## 16 -1553.       0.1 tx        2021-05-30    2021-05-31 
## 17  2301.       0.9 tx        2021-05-30    2021-05-31 
## 18   174       NA   tx        2021-05-31    2021-06-01 
## 19 -1753.       0.1 tx        2021-05-31    2021-06-01 
## 20  2101.       0.9 tx        2021-05-31    2021-06-01</code></pre>
<p>We can do a more complicated “local autoregressive” forecast by using trailing windows. Here, by default, we use 0-, 1-, and 2- week lags to forecast 1 day ahead.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">local_ar</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">lags</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">7</span>, <span class="fl">14</span><span class="op">)</span>, <span class="va">ahead</span> <span class="op">=</span> <span class="fl">1</span>, <span class="va">min_train_window</span> <span class="op">=</span> <span class="fl">56</span>, 
                     <span class="va">quantile_levels</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.9</span><span class="op">)</span>, <span class="va">symmetrize</span> <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">ahead</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">ahead</span><span class="op">)</span>
  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">&lt;</span> <span class="va">min_train_window</span> <span class="op">+</span> <span class="va">ahead</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">lags</span><span class="op">)</span><span class="op">)</span>  
    <span class="co"># return NA forecasts if insufficient data</span>
    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>value <span class="op">=</span> <span class="cn">NA</span>, quantile <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="va">quantile_levels</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/all.html">all</a></span><span class="op">(</span><span class="va">lags</span> <span class="op">&gt;</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span>, <span class="va">ahead</span> <span class="op">&gt;</span> <span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">lags</span><span class="op">)</span> <span class="op">+</span> <span class="va">ahead</span> <span class="op">&lt;</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>
  <span class="va">lags</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span><span class="op">(</span><span class="va">lags</span><span class="op">)</span>
  <span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">symmetrize</span>, <span class="op">-</span><span class="fl">1</span>, <span class="cn">NA</span><span class="op">)</span>
  <span class="va">ma</span> <span class="op">&lt;-</span> <span class="va">ahead</span> <span class="op">+</span> <span class="fl">1</span>
  <span class="va">ml</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">lags</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span>
  <span class="va">mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/embed.html">embed</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">ml</span> <span class="op">+</span> <span class="va">ma</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span>
  <span class="va">y</span> <span class="op">&lt;-</span> <span class="va">mat</span><span class="op">[</span>, <span class="va">ma</span> <span class="op">-</span> <span class="va">ahead</span><span class="op">]</span>
  <span class="va">X</span> <span class="op">&lt;-</span> <span class="va">mat</span><span class="op">[</span>, <span class="va">lags</span> <span class="op">+</span> <span class="va">ma</span><span class="op">]</span>
  <span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">X</span><span class="op">)</span>
  <span class="va">newx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rev.html">rev</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">tail</a></span><span class="op">(</span><span class="va">x</span>, n <span class="op">=</span> <span class="va">ml</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="va">lags</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span>
  <span class="va">point</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/drop.html">drop</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">newx</span><span class="op">)</span> <span class="op">%*%</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span><span class="op">)</span>
  <span class="va">resids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span>, <span class="va">s</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span><span class="op">)</span>
  <span class="va">q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">resids</span>, probs <span class="op">=</span> <span class="va">quantile_levels</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>value <span class="op">=</span> <span class="va">q</span> <span class="op">+</span> <span class="va">point</span>, 
             quantile <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="va">quantile_levels</span><span class="op">)</span>, 
             row.names <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">ar_fcasts</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="../reference/slide_by_geo.html">slide_by_geo</a></span><span class="op">(</span>slide_fun <span class="op">=</span> <span class="op">~</span> <span class="fu">local_ar</span><span class="op">(</span><span class="va">.x</span><span class="op">$</span><span class="va">value</span><span class="op">)</span>, 
               n <span class="op">=</span> <span class="fl">100</span>, col_type <span class="op">=</span> <span class="st">"list"</span>, col_name <span class="op">=</span> <span class="st">"value"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>forecast_date <span class="op">=</span> <span class="va">time_value</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>target_date <span class="op">=</span> <span class="va">forecast_date</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">issue</span><span class="op">)</span>

<span class="va">ar_fcasts</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">tail</a></span><span class="op">(</span><span class="fl">20</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 20 × 5
##    value quantile geo_value forecast_date target_date
##    &lt;dbl&gt;    &lt;dbl&gt; &lt;chr&gt;     &lt;date&gt;        &lt;date&gt;     
##  1 1319.      0.1 tx        2021-05-25    2021-05-26 
##  2 4389.      0.9 tx        2021-05-25    2021-05-26 
##  3 2519.     NA   tx        2021-05-26    2021-05-27 
##  4 1022.      0.1 tx        2021-05-26    2021-05-27 
##  5 4015.      0.9 tx        2021-05-26    2021-05-27 
##  6 2241.     NA   tx        2021-05-27    2021-05-28 
##  7  834.      0.1 tx        2021-05-27    2021-05-28 
##  8 3648.      0.9 tx        2021-05-27    2021-05-28 
##  9 2335.     NA   tx        2021-05-28    2021-05-29 
## 10  951.      0.1 tx        2021-05-28    2021-05-29 
## 11 3719.      0.9 tx        2021-05-28    2021-05-29 
## 12 1810.     NA   tx        2021-05-29    2021-05-30 
## 13  385.      0.1 tx        2021-05-29    2021-05-30 
## 14 3234.      0.9 tx        2021-05-29    2021-05-30 
## 15 1545.     NA   tx        2021-05-30    2021-05-31 
## 16  134.      0.1 tx        2021-05-30    2021-05-31 
## 17 2956.      0.9 tx        2021-05-30    2021-05-31 
## 18 2020.     NA   tx        2021-05-31    2021-06-01 
## 19  591.      0.1 tx        2021-05-31    2021-06-01 
## 20 3449.      0.9 tx        2021-05-31    2021-06-01</code></pre>
<p>If we want to make forecasts using weekly data, we can apply <code><a href="../reference/slide_by_geo.html">slide_by_geo()</a></code> twice: first to create weekly sums, then to do the forecast. We wrap this in a function to use a few times.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">n_week_ar</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">ahead</span> <span class="op">=</span> <span class="fl">7</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">x</span> <span class="op">%&gt;%</span> 
    <span class="co"># sums but with imputed NAs</span>
    <span class="fu"><a href="../reference/slide_by_geo.html">slide_by_geo</a></span><span class="op">(</span> <span class="op">~</span> <span class="fu"><a href="../reference/Min.html">Mean</a></span><span class="op">(</span><span class="va">.x</span><span class="op">$</span><span class="va">value</span><span class="op">)</span> <span class="op">*</span> <span class="fl">7</span>, n <span class="op">=</span> <span class="fl">7</span>, col_name <span class="op">=</span> <span class="st">"value"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="../reference/slide_by_geo.html">slide_by_geo</a></span><span class="op">(</span><span class="va">x</span>, slide_fun <span class="op">=</span> <span class="op">~</span> <span class="fu">local_ar</span><span class="op">(</span><span class="va">.x</span><span class="op">$</span><span class="va">value</span>, ahead <span class="op">=</span> <span class="va">ahead</span><span class="op">)</span>, 
                 n <span class="op">=</span> <span class="fl">100</span>, col_name <span class="op">=</span> <span class="st">"value"</span>, col_type <span class="op">=</span> <span class="st">"list"</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>forecast_date <span class="op">=</span> <span class="va">time_value</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>target_date <span class="op">=</span> <span class="va">forecast_date</span> <span class="op">+</span> <span class="va">ahead</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">issue</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">one_week_ar</span> <span class="op">&lt;-</span> <span class="fu">n_week_ar</span><span class="op">(</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">tail</a></span><span class="op">(</span><span class="va">one_week_ar</span>, <span class="fl">20</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 20 × 5
##     value quantile geo_value forecast_date target_date
##     &lt;dbl&gt;    &lt;dbl&gt; &lt;chr&gt;     &lt;date&gt;        &lt;date&gt;     
##  1 10779.      0.1 tx        2021-05-25    2021-06-01 
##  2 17999.      0.9 tx        2021-05-25    2021-06-01 
##  3 14336.     NA   tx        2021-05-26    2021-06-02 
##  4 10783.      0.1 tx        2021-05-26    2021-06-02 
##  5 17890.      0.9 tx        2021-05-26    2021-06-02 
##  6 14139.     NA   tx        2021-05-27    2021-06-03 
##  7 10546.      0.1 tx        2021-05-27    2021-06-03 
##  8 17732.      0.9 tx        2021-05-27    2021-06-03 
##  9 13862.     NA   tx        2021-05-28    2021-06-04 
## 10 10417.      0.1 tx        2021-05-28    2021-06-04 
## 11 17306.      0.9 tx        2021-05-28    2021-06-04 
## 12 13218.     NA   tx        2021-05-29    2021-06-05 
## 13  9790.      0.1 tx        2021-05-29    2021-06-05 
## 14 16646.      0.9 tx        2021-05-29    2021-06-05 
## 15 12732.     NA   tx        2021-05-30    2021-06-06 
## 16  9343.      0.1 tx        2021-05-30    2021-06-06 
## 17 16122.      0.9 tx        2021-05-30    2021-06-06 
## 18 10675.     NA   tx        2021-05-31    2021-06-07 
## 19  7240.      0.1 tx        2021-05-31    2021-06-07 
## 20 14111.      0.9 tx        2021-05-31    2021-06-07</code></pre>
<p>Note that with both of these forecasting tasks, we are unfairly using “finalized” data, the data that is currently available to us. This may not be the same as the data that would have been available at the <code>forecast_date</code>. See <code>?covidcast::covidcast_signal()</code> for some discuss on “Issue dates and revisions”.</p>
<p>Finally, we can visualize the forecasts with a little bit of data wrangling. Here, we also create 2 and 3 week ahead forecasts, and plot the results for a few forecast dates.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">multi_week_forecasts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span><span class="va">one_week_ar</span>, <span class="fu">n_week_ar</span><span class="op">(</span><span class="fl">14</span><span class="op">)</span>, <span class="fu">n_week_ar</span><span class="op">(</span><span class="fl">21</span><span class="op">)</span><span class="op">)</span>
<span class="va">dates_to_show</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"2021-02-01"</span><span class="op">)</span>, by <span class="op">=</span> <span class="st">"month"</span>, length <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>
<span class="va">fcast_fan</span> <span class="op">&lt;-</span> <span class="va">multi_week_forecasts</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">forecast_date</span> <span class="op">%in%</span> <span class="va">dates_to_show</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">forecast_date</span>, <span class="va">target_date</span>, <span class="va">geo_value</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>quantile <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">quantile</span><span class="op">)</span> <span class="op">~</span> <span class="st">"point"</span>, 
    <span class="va">quantile</span> <span class="op">&lt;</span> <span class="fl">.5</span> <span class="op">~</span> <span class="st">"lo"</span>, 
    <span class="cn">TRUE</span> <span class="op">~</span> <span class="st">"hi"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">quantile</span>, values_from <span class="op">=</span> <span class="va">value</span><span class="op">)</span>
<span class="va">weekly_totals</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="../reference/slide_by_geo.html">slide_by_geo</a></span><span class="op">(</span> <span class="op">~</span> <span class="fu"><a href="../reference/Min.html">Mean</a></span><span class="op">(</span><span class="va">.x</span><span class="op">$</span><span class="va">value</span><span class="op">)</span> <span class="op">*</span> <span class="fl">7</span>, n <span class="op">=</span> <span class="fl">7</span>, col_name <span class="op">=</span> <span class="st">"value"</span><span class="op">)</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">fcast_fan</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">target_date</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">lo</span>, ymax <span class="op">=</span> <span class="va">hi</span>, group <span class="op">=</span> <span class="va">forecast_date</span><span class="op">)</span>,
              fill <span class="op">=</span> <span class="st">"cornflowerblue"</span>, alpha <span class="op">=</span> <span class="fl">.75</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">point</span>, group <span class="op">=</span> <span class="va">forecast_date</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"orange"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">point</span>, group <span class="op">=</span> <span class="va">forecast_date</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"orange"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">geo_value</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">weekly_totals</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">time_value</span>, <span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html">coord_cartesian</a></span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2021-01-01"</span>, <span class="st">"2021-06-01"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"Weekly COVID-19 cases"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"Date"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/label_number_si.html">label_number_si</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> </code></pre></div>
<p><img src="slide_files/figure-html/unnamed-chunk-10-1.png" width="864"></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Ryan Tibshirani.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
