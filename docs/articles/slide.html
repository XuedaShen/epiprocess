<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>1. Slide a computation over signal values • epitools</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="1. Slide a computation over signal values">
<meta property="og:description" content="Slide a computation over signal values over time.">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">epitools</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/epitools.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/slide.html">1. Slide a computation over signal values</a>
    </li>
    <li>
      <a href="../articles/pct-change.html">2. Compute percentage change over time</a>
    </li>
    <li>
      <a href="../articles/derivatives.html">3. Estimate derivatives of signals</a>
    </li>
    <li>
      <a href="../articles/correlations.html">4. Compute correlations between signals</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/cmu-delphi/epitools/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="slide_files/header-attrs-2.10/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>1. Slide a computation over signal values</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/cmu-delphi/epitools/vignettes/slide.Rmd"><code>vignettes/slide.Rmd</code></a></small>
      <div class="hidden name"><code>slide.Rmd</code></div>

    </div>

    
    
<p>One of the most basic tools in the <code>epitools</code> package is <code><a href="../reference/slide_by_geo.html">slide_by_geo()</a></code>, which is based on the family of functions provided by the <a href="https://cran.r-project.org/web/packages/slider/"><code>slider</code></a> package. In <code>epitools</code>, to “slide” means to apply a computation—represented as a function or formula—over a trailing window of <code>n</code> days of data, grouped by <code>geo_value</code>. Several other functions in the <code>epitools</code> package, such as <code><a href="../reference/pct_change.html">pct_change()</a></code> and <code><a href="../reference/estimate_deriv.html">estimate_deriv()</a></code>, use <code><a href="../reference/slide_by_geo.html">slide_by_geo()</a></code> as their workhorse.</p>
<p>Similar to the getting started guide, we’ll fetch daily reported COVID-19 cases for a few U.S. states (note: new, not cumulative cases) using the <a href="https://cmu-delphi.github.io/covidcast/covidcastR/"><code>covidcast</code></a> package, and then convert this to <code>epi_signal</code> format.</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">covidcast</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">epitools</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">dplyr</span>)

<span class="no">x</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/covidcast/man/covidcast_signal.html">covidcast_signal</a></span>(<span class="kw">data_source</span> <span class="kw">=</span> <span class="st">"jhu-csse"</span>,
                      <span class="kw">signal</span> <span class="kw">=</span> <span class="st">"confirmed_incidence_num"</span>,
                      <span class="kw">start_day</span> <span class="kw">=</span> <span class="st">"2020-06-01"</span>,
                      <span class="kw">end_day</span> <span class="kw">=</span> <span class="st">"2021-05-31"</span>,
                      <span class="kw">geo_type</span> <span class="kw">=</span> <span class="st">"state"</span>,
                      <span class="kw">geo_values</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"ca"</span>, <span class="st">"fl"</span>, <span class="st">"ny"</span>, <span class="st">"tx"</span>))  <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/as.epi_signal.html">as.epi_signal</a></span>(<span class="kw">name</span> <span class="kw">=</span> <span class="st">"covid19_cases"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="no">value</span>, <span class="no">geo_value</span>, <span class="no">time_value</span>)</pre></body></html></div>
<div id="slide-with-a-formula" class="section level2">
<h2 class="hasAnchor">
<a href="#slide-with-a-formula" class="anchor"></a>Slide with a formula</h2>
<p>We first demonstrate how to apply a 7-day trailing average to the daily counts in order to smooth the signal, by using a formula in the <code>slide_fun</code> argument of <code><a href="../reference/slide_by_geo.html">slide_by_geo()</a></code>.</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="no">x</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/slide_by_geo.html">slide_by_geo</a></span>(<span class="no">x</span>, <span class="kw">slide_fun</span> <span class="kw">=</span> ~ <span class="fu"><a href="../reference/Min.html">Mean</a></span>(<span class="no">.x</span>$<span class="no">value</span>), <span class="kw">n</span> <span class="kw">=</span> <span class="fl">7</span>)
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">x</span>, <span class="fl">10</span>)</pre></body></html></div>
<pre><code>## # A tibble: 10 × 4
##    value geo_value time_value slide_value
##    &lt;dbl&gt; &lt;chr&gt;     &lt;date&gt;           &lt;dbl&gt;
##  1  2360 ca        2020-06-01       2360 
##  2  2372 ca        2020-06-02       2366 
##  3  2214 ca        2020-06-03       2315.
##  4  3011 ca        2020-06-04       2489.
##  5  3025 ca        2020-06-05       2596.
##  6  3046 ca        2020-06-06       2671.
##  7  2404 ca        2020-06-07       2633.
##  8  2385 ca        2020-06-08       2637.
##  9  2700 ca        2020-06-09       2684.
## 10  3208 ca        2020-06-10       2826.</code></pre>
<p>The formula specified via <code>slide_fun</code> has access to all columns present in the original <code>epi_signal</code> data frame, and must refer to them with the prefix <code>.x$</code>. Here the function <code><a href="../reference/Min.html">Mean()</a></code> is a simple wrapper around <code><a href="https://rdrr.io/r/base/mean.html">mean()</a></code> that omits <code>NA</code> values by default (provided by the <code>epitools</code> package).</p>
<p>Notice that <code><a href="../reference/slide_by_geo.html">slide_by_geo()</a></code> returns a data frame with a new column appended that contains the results (from sliding the formula), named <code>slide_value</code> by default. We can instead specify a name up front using the <code>col_name</code> argument:</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="no">x</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/slide_by_geo.html">slide_by_geo</a></span>(<span class="no">x</span>, <span class="kw">slide_fun</span> <span class="kw">=</span> ~ <span class="fu"><a href="../reference/Min.html">Mean</a></span>(<span class="no">.x</span>$<span class="no">value</span>), <span class="kw">n</span> <span class="kw">=</span> <span class="fl">7</span>, <span class="kw">col_name</span> <span class="kw">=</span> <span class="st">"7dav"</span>)
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">x</span>, <span class="fl">10</span>)</pre></body></html></div>
<pre><code>## # A tibble: 10 × 5
##    value geo_value time_value slide_value `7dav`
##    &lt;dbl&gt; &lt;chr&gt;     &lt;date&gt;           &lt;dbl&gt;  &lt;dbl&gt;
##  1  2360 ca        2020-06-01       2360   2360 
##  2  2372 ca        2020-06-02       2366   2366 
##  3  2214 ca        2020-06-03       2315.  2315.
##  4  3011 ca        2020-06-04       2489.  2489.
##  5  3025 ca        2020-06-05       2596.  2596.
##  6  3046 ca        2020-06-06       2671.  2671.
##  7  2404 ca        2020-06-07       2633.  2633.
##  8  2385 ca        2020-06-08       2637.  2637.
##  9  2700 ca        2020-06-09       2684.  2684.
## 10  3208 ca        2020-06-10       2826.  2826.</code></pre>
<p>As a simple sanity check, we visualize the 7-day trailing averages computed on top of the original counts:</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">ggplot2</span>)
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html">theme_set</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span>())

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="no">x</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">time_value</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_col</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">y</span> <span class="kw">=</span> <span class="no">value</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="no">geo_value</span>), <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.5</span>, <span class="kw">show.legend</span> <span class="kw">=</span> <span class="fl">FALSE</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">y</span> <span class="kw">=</span> <span class="no">`7dav`</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="no">geo_value</span>), <span class="kw">show.legend</span> <span class="kw">=</span> <span class="fl">FALSE</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span>(~ <span class="no">geo_value</span>, <span class="kw">scales</span> <span class="kw">=</span> <span class="st">"free_y"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html">scale_x_date</a></span>(<span class="kw">minor_breaks</span> <span class="kw">=</span> <span class="st">"month"</span>, <span class="kw">date_labels</span> <span class="kw">=</span> <span class="st">"%b %y"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="st">"Date"</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="st">"Reported COVID-19 cases"</span>)</pre></body></html></div>
<p><img src="slide_files/figure-html/unnamed-chunk-4-1.png" width="864"></p>
</div>
<div id="slide-with-a-function" class="section level2">
<h2 class="hasAnchor">
<a href="#slide-with-a-function" class="anchor"></a>Slide with a function</h2>
<p>We can also pass a function for the <code>slide_fun</code> argument in <code><a href="../reference/slide_by_geo.html">slide_by_geo()</a></code>. In this case, the passed function must have the following argument structure: <code>x</code>, a data frame the same column names as the original data frame; followed by any number of named additional arguments; and ending with <code>...</code>, to capture general additional arguments. Recreating the last example of a 7-day trailing average:</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="no">x</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/slide_by_geo.html">slide_by_geo</a></span>(<span class="no">x</span>, <span class="kw">slide_fun</span> <span class="kw">=</span> <span class="kw">function</span>(<span class="no">x</span>, <span class="no">...</span>) <span class="fu"><a href="../reference/Min.html">Mean</a></span>(<span class="no">x</span>$<span class="no">value</span>), <span class="kw">n</span> <span class="kw">=</span> <span class="fl">7</span>,
                  <span class="kw">col_name</span> <span class="kw">=</span> <span class="st">"7dav"</span>)
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">x</span>, <span class="fl">10</span>)</pre></body></html></div>
<pre><code>## # A tibble: 10 × 5
##    value geo_value time_value slide_value `7dav`
##    &lt;dbl&gt; &lt;chr&gt;     &lt;date&gt;           &lt;dbl&gt;  &lt;dbl&gt;
##  1  2360 ca        2020-06-01       2360   2360 
##  2  2372 ca        2020-06-02       2366   2366 
##  3  2214 ca        2020-06-03       2315.  2315.
##  4  3011 ca        2020-06-04       2489.  2489.
##  5  3025 ca        2020-06-05       2596.  2596.
##  6  3046 ca        2020-06-06       2671.  2671.
##  7  2404 ca        2020-06-07       2633.  2633.
##  8  2385 ca        2020-06-08       2637.  2637.
##  9  2700 ca        2020-06-09       2684.  2684.
## 10  3208 ca        2020-06-10       2826.  2826.</code></pre>
</div>
<div id="building-and-running-a-local-forecaster" class="section level2">
<h2 class="hasAnchor">
<a href="#building-and-running-a-local-forecaster" class="anchor"></a>Building and running a local forecaster</h2>
<p>As a more complicated example, we create a forecaster based on a local (in time) autoregression or AR model. AR models can be fit in numerous ways (using base R functions and various packages), but here we define it “by hand” both because it provides a more advanced example of sliding a function over an <code>epi_signal</code> object, and because it allows us to be a bit more flexible in defining a <em>probabilistic</em> forecaster: one that outputs not just a point prediction, but a notion of uncertainty around this. In particular, our forecaster will output a point prediction along with an 90% uncertainty band, represented by a predictive quantiles at the 5% and 95% levels (lower and upper endpoints of the uncertainty band).</p>
<p>The function defined below, <code>prob_ar()</code>, is our probabilistic AR forecaster. The <code>lags</code>argument indicates which lags to use in the model, and <code>ahead</code> indicates how far ahead in the future to make forecasts (both are encoded in terms of the units of the <code>time_value</code> column; so, days, in the working <code>epi_signal</code> being considered in this vignette).</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="no">prob_ar</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">v</span>, <span class="no">lags</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>, <span class="fl">7</span>, <span class="fl">14</span>), <span class="no">ahead</span> <span class="kw">=</span> <span class="fl">7</span>, <span class="no">min_train_window</span> <span class="kw">=</span> <span class="fl">20</span>,
                    <span class="no">lower_level</span> <span class="kw">=</span> <span class="fl">0.05</span>, <span class="no">upper_level</span> <span class="kw">=</span> <span class="fl">0.95</span>, <span class="no">symmetrize</span> <span class="kw">=</span> <span class="fl">TRUE</span>) {
  <span class="co"># Return NA if insufficient training data</span>
  <span class="kw">if</span> (<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">v</span>) <span class="kw">&lt;</span> <span class="no">min_train_window</span> + <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="no">lags</span>) + <span class="no">ahead</span>) {
    <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">point</span> <span class="kw">=</span> <span class="fl">NA</span>, <span class="kw">lower</span> <span class="kw">=</span> <span class="fl">NA</span>, <span class="kw">upper</span> <span class="kw">=</span> <span class="fl">NA</span>))
  }

  <span class="co"># Perform other simple checks</span>
  <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html">stopifnot</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/all.html">all</a></span>(<span class="no">lags</span> <span class="kw">&gt;=</span> <span class="fl">0</span>), <span class="no">ahead</span> <span class="kw">&gt;</span> <span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="no">lags</span>) + <span class="no">ahead</span> <span class="kw">&lt;</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">v</span>))

  <span class="co"># Go and fit the AR model</span>
  <span class="no">y</span> <span class="kw">&lt;-</span> <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lead</a></span>(<span class="no">v</span>, <span class="kw">n</span> <span class="kw">=</span> <span class="no">ahead</span>)
  <span class="no">x</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span>(<span class="no">cbind</span>, <span class="kw pkg">purrr</span><span class="kw ns">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span>(<span class="no">lags</span>, ~ <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span>(<span class="no">v</span>, <span class="kw">n</span> <span class="kw">=</span> <span class="no">.x</span>)))
  <span class="no">fit</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span>(<span class="no">y</span> ~ <span class="no">x</span>, <span class="kw">na.action</span> <span class="kw">=</span> <span class="no">na.omit</span>)

  <span class="co"># Make a prediction</span>
  <span class="no">newx</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">tail</a></span>(<span class="no">x</span>, <span class="fl">1</span>)
  <span class="no">point</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/drop.html">drop</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>, <span class="no">newx</span>) <span class="kw">%*%</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span>(<span class="no">fit</span>))

  <span class="co"># Compute a band and return</span>
  <span class="no">r</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span>(<span class="no">fit</span>)
  <span class="no">s</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="no">symmetrize</span>, -<span class="fl">1</span>, <span class="fl">NA</span>) <span class="co"># Should the residuals be symmetrized?</span>
  <span class="no">q</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">r</span>, <span class="no">s</span> * <span class="no">r</span>), <span class="kw">probs</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">lower_level</span>, <span class="no">upper_level</span>), <span class="kw">na.rm</span> <span class="kw">=</span> <span class="fl">TRUE</span>)
  <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">point</span> <span class="kw">=</span> <span class="no">point</span>, <span class="kw">lower</span> <span class="kw">=</span> <span class="no">point</span> + <span class="no">q</span>[<span class="fl">1</span>], <span class="kw">upper</span> <span class="kw">=</span> <span class="no">point</span> + <span class="no">q</span>[<span class="fl">2</span>]))
}</pre></body></html></div>
<p>Now we go ahead and slide this AR forecaster over the working <code>epi_signal</code> of COVID-19 cases. Note that we actually model the <code>7dav</code> column, to operate on the scale of smoothed COVID-19 cases. (This is clearly equivalent, up to a constant, to modeling weekly sums of COVID-19 cases.)</p>
<div class="sourceCode" id="cb10"><html><body><pre class="r"><span class="no">z</span> <span class="kw">&lt;-</span> <span class="no">x</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/slide_by_geo.html">slide_by_geo</a></span>(<span class="kw">slide_fun</span> <span class="kw">=</span> ~ <span class="fu">prob_ar</span>(<span class="no">.x</span>$<span class="no">`7dav`</span>), <span class="kw">n</span> <span class="kw">=</span> <span class="fl">100</span>,
               <span class="kw">col_type</span> <span class="kw">=</span> <span class="st">"list"</span>, <span class="kw">col_name</span> <span class="kw">=</span> <span class="st">"forecast"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">target_date</span> <span class="kw">=</span> <span class="no">time_value</span> + <span class="fl">7</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(-<span class="no">value</span>, -<span class="no">slide_value</span>)

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">tail</a></span>(<span class="no">z</span>, <span class="fl">3</span>)</pre></body></html></div>
<pre><code>## An `epi_signal` data frame with 3 rows and 5 columns.
## 
## name      : covid19_cases
## geo_type  : state
## time_type : day
## 
## # A tibble: 3 × 5
##   geo_value time_value `7dav` forecast     target_date
##   &lt;chr&gt;     &lt;date&gt;      &lt;dbl&gt; &lt;list&gt;       &lt;date&gt;     
## 1 tx        2021-05-29  1740. &lt;df [1 × 3]&gt; 2021-06-05 
## 2 tx        2021-05-30  1692. &lt;df [1 × 3]&gt; 2021-06-06 
## 3 tx        2021-05-31  1306. &lt;df [1 × 3]&gt; 2021-06-07</code></pre>
<p>We can see that the <code>forecast</code> column is a list column (as specified in the call to <code>slide_to_geo()</code>, which was needed since <code>prob_ar()</code> returns a data frame), and we can use <code><a href="https://tidyr.tidyverse.org/reference/nest.html">tidyr::unnest()</a></code> to unnest it.</p>
<div class="sourceCode" id="cb12"><html><body><pre class="r"><span class="no">z</span> <span class="kw">&lt;-</span> <span class="kw pkg">tidyr</span><span class="kw ns">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span>(<span class="no">z</span>, <span class="no">forecast</span>)
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">tail</a></span>(<span class="no">z</span>, <span class="fl">10</span>)</pre></body></html></div>
<pre><code>## # A tibble: 10 × 7
##    geo_value time_value `7dav` point lower upper target_date
##    &lt;chr&gt;     &lt;date&gt;      &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;date&gt;     
##  1 tx        2021-05-22  1756. 2078. 1448. 2709. 2021-05-29 
##  2 tx        2021-05-23  1763. 2067. 1437. 2696. 2021-05-30 
##  3 tx        2021-05-24  1824. 2069. 1434. 2703. 2021-05-31 
##  4 tx        2021-05-25  1743  2056. 1473. 2638. 2021-06-01 
##  5 tx        2021-05-26  1767. 2048. 1480. 2616. 2021-06-02 
##  6 tx        2021-05-27  1761. 2020. 1449. 2591. 2021-06-03 
##  7 tx        2021-05-28  1802  1980. 1389. 2571. 2021-06-04 
##  8 tx        2021-05-29  1740. 1888. 1272. 2505. 2021-06-05 
##  9 tx        2021-05-30  1692. 1819. 1171. 2466. 2021-06-06 
## 10 tx        2021-05-31  1306. 1525.  878. 2172. 2021-06-07</code></pre>
<p>Now we get three columns <code>point</code>, <code>lower</code>, and <code>upper</code> corresponding to the point forecast, and the lower and upper endpoints of the 95% prediction band, respectively.</p>
<p>To finish off, we plot the forecasts at some times (spaced out by a few months) over the last year, at multiple horizons (7, 14, and 28 days ahead). To do so, we encapsulate the process of generating forecasts into a simple function, so that we can call it a few times.</p>
<div class="sourceCode" id="cb14"><html><body><pre class="r"><span class="no">k_week_ahead</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">x</span>, <span class="no">ahead</span> <span class="kw">=</span> <span class="fl">7</span>) {
  <span class="no">x</span> <span class="kw">%&gt;%</span>
    <span class="fu"><a href="../reference/slide_by_geo.html">slide_by_geo</a></span>(<span class="kw">slide_fun</span> <span class="kw">=</span> ~ <span class="fu">prob_ar</span>(<span class="no">.x</span>$<span class="no">`7dav`</span>, <span class="kw">ahead</span> <span class="kw">=</span> <span class="no">ahead</span>),
                 <span class="kw">n</span> <span class="kw">=</span> <span class="fl">100</span>, <span class="kw">col_type</span> <span class="kw">=</span> <span class="st">"list"</span>, <span class="kw">col_name</span> <span class="kw">=</span> <span class="st">"forecast"</span>) <span class="kw">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">target_date</span> <span class="kw">=</span> <span class="no">time_value</span> + <span class="no">ahead</span>) <span class="kw">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(-<span class="no">value</span>, -<span class="no">slide_value</span>) <span class="kw">%&gt;%</span>
    <span class="kw pkg">tidyr</span><span class="kw ns">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span>(<span class="no">forecast</span>)
}

<span class="co"># First generate the forecasts, and bind them together</span>
<span class="no">z</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span>(<span class="fu">k_week_ahead</span>(<span class="no">x</span>, <span class="kw">ahead</span> <span class="kw">=</span> <span class="fl">7</span>),
               <span class="fu">k_week_ahead</span>(<span class="no">x</span>, <span class="kw">ahead</span> <span class="kw">=</span> <span class="fl">14</span>),
               <span class="fu">k_week_ahead</span>(<span class="no">x</span>, <span class="kw">ahead</span> <span class="kw">=</span> <span class="fl">28</span>))

<span class="co"># Now plot some of them, spaced apart by 2 months</span>
<span class="no">z_to_show</span> <span class="kw">&lt;-</span> <span class="no">z</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="no">time_value</span> <span class="kw">%in%</span>
           <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span>(<span class="st">"2020-08-01"</span>), <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span>(<span class="st">"2021-06-01"</span>), <span class="kw">by</span> <span class="kw">=</span> <span class="st">"2 months"</span>))

<span class="no">p</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="no">z_to_show</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">target_date</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">point</span>, <span class="kw">group</span> <span class="kw">=</span> <span class="no">time_value</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">ymin</span> <span class="kw">=</span> <span class="no">lower</span>, <span class="kw">ymax</span> <span class="kw">=</span> <span class="no">upper</span>), <span class="kw">fill</span> <span class="kw">=</span> <span class="st">"orchid"</span>, <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.5</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>() + <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>(<span class="kw">size</span> <span class="kw">=</span> <span class="fl">0.5</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">xintercept</span> <span class="kw">=</span> <span class="no">time_value</span>), <span class="kw">linetype</span> <span class="kw">=</span> <span class="fl">2</span>, <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.5</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html">vars</a></span>(<span class="no">geo_value</span>), <span class="kw">scales</span> <span class="kw">=</span> <span class="st">"free_y"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html">scale_x_date</a></span>(<span class="kw">minor_breaks</span> <span class="kw">=</span> <span class="st">"month"</span>, <span class="kw">date_labels</span> <span class="kw">=</span> <span class="st">"%b %y"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="st">"Date"</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="st">"Reported COVID-19 cases"</span>)

<span class="kw pkg">gginnards</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/gginnards/man/delete_layers.html">append_layers</a></span>(
  <span class="no">p</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">z</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">time_value</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">`7dav`</span>),
               <span class="kw">inherit.aes</span> <span class="kw">=</span> <span class="fl">FALSE</span>, <span class="kw">color</span> <span class="kw">=</span> <span class="st">"gray50"</span>), <span class="kw">pos</span> <span class="kw">=</span> <span class="st">"bottom"</span>)</pre></body></html></div>
<p><img src="slide_files/figure-html/unnamed-chunk-9-1.png" width="864"></p>
<p>Two points are worth making. First, the AR model’s performance here is pretty mixed. At various points in time, we can see that its forecasts are volatile (its point predictions are all over the place), or overconfident (its bands are too narrow), or both at the same time. This is only meant as a simple demo and slightly more sophisticated AR models can go a long way. For example, the overconfidence in this example is due to the fact that the bands are based on quantiles of training residuals, and when the AR model fits well to the training set, these can clearly be too small in magnitude.</p>
<p>Second, the AR forecaster here is using using finalized data, meaning, it uses the signal values (reported COVID-19 cases) corresponding to the latest issue dates available, for both training models and making predictions. However, this is not reflective of the provisional nature of the data that it must cope with in a true forecast task. Training and making predictions on finalized data can lead to an overly optimismic sense of accuracy; see, for example, <a href="https://www.medrxiv.org/content/10.1101/2021.06.22.21259346">McDonald et al. (2021)</a>, and references therein.</p>
<p>todo: refer to other functionality in the current package or in the <a href="https://cmu-delphi.github.io/epipred/"><code>epipred</code></a> package?</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Ryan Tibshirani.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
