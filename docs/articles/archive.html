<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Work with archive objects and data revisions • epiprocess</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Work with archive objects and data revisions">
<meta property="og:description" content="epiprocess">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">epiprocess</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/epiprocess.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/slide.html">Slide a computation over signal values</a>
    </li>
    <li>
      <a href="../articles/archive.html">Work with archive objects and data revisions</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/cmu-delphi/epiprocess/tree/main/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="archive_files/header-attrs-2.10/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Work with archive objects and data revisions</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/cmu-delphi/epiprocess/blob/main/vignettes/archive.Rmd"><code>vignettes/archive.Rmd</code></a></small>
      <div class="hidden name"><code>archive.Rmd</code></div>

    </div>

    
    
<p>In addition to the <code>epi_df</code> data structure, which we have been working with all along in these vignettes, the <code>epiprocess</code> package has a companion structure called <code>epi_archive</code>. In comparison to an <code>epi_df</code> object, which can be seen as storing a single snapshot of a data set with the most up-to-date signal values as of some given time, an <code>epi_archive</code> object stores the full version history of a data set. Many signals of interest for epidemiological tracking are subject to revision (some more than others), and paying attention to data revisions can be important for all sorts of downstream data analysis and modeling tasks.</p>
<p>This vignette walks through working with <code>epi_archive</code> objects and demonstrates some of their key functionality. We’ll work with a signal on the percentage of doctor’s visits with CLI (COVID-like illness) computed from medical insurance claims, available through the <a href="https://cmu-delphi.github.io/delphi-epidata/api/covidcast.html/">COVIDcast API</a>. This signal is subject to very heavy and regular revision; you can read more about it on its <a href="https://cmu-delphi.github.io/delphi-epidata/api/covidcast-signals/doctor-visits.html">API documentation page</a>.</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">covidcast</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">epiprocess</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">data.table</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">dplyr</span>)

<span class="no">dv</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/covidcast/man/covidcast_signal.html">covidcast_signal</a></span>(<span class="st">"doctor-visits"</span>,
                       <span class="st">"smoothed_adj_cli"</span>,
                       <span class="kw">start_day</span> <span class="kw">=</span> <span class="st">"2020-06-01"</span>,
                       <span class="kw">end_day</span> <span class="kw">=</span> <span class="st">"2021-12-01"</span>,
                       <span class="kw">issues</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"2020-06-01"</span>, <span class="st">"2021-12-01"</span>),
                       <span class="kw">geo_type</span> <span class="kw">=</span> <span class="st">"state"</span>,
                       <span class="kw">geo_values</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"ca"</span>, <span class="st">"fl"</span>))</pre></body></html></div>
<pre><code>## Warning: Data not fetched for the following days: 2021-11-27, 2021-11-28,
## 2021-11-29, 2021-11-30, 2021-12-01</code></pre>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">dv</span>)</pre></body></html></div>
<pre><code>##  [1] "data_source"         "signal"              "geo_value"          
##  [4] "time_value"          "source"              "geo_type"           
##  [7] "time_type"           "issue"               "lag"                
## [10] "missing_value"       "missing_stderr"      "missing_sample_size"
## [13] "value"               "stderr"              "sample_size"</code></pre>
<div id="getting-data-into-epi_archive-format" class="section level2">
<h2 class="hasAnchor">
<a href="#getting-data-into-epi_archive-format" class="anchor"></a>Getting data into <code>epi_archive</code> format</h2>
<p>An <code><a href="../reference/epi_archive.html">epi_archive</a></code> object can be constructed from a data frame, data table, or tibble, provided that it has (at least) the following columns:</p>
<ul>
<li>
<code>geo_value</code>: the geographic value associated with each row of measurements.</li>
<li>
<code>time_value</code>: the time value associated with each row of measurements.</li>
<li>
<code>version</code>: the time value specifying the version for each row of measurements. For example, if in a given row the <code>version</code> is January 15, 2022 and <code>time_value</code> is January 14, 2022, then this row contains the measurements of the data for January 14, 2022 that were available one day later.</li>
</ul>
<p>As we can see from the above, the data frame returned by <code><a href="https://rdrr.io/pkg/covidcast/man/covidcast_signal.html">covidcast::covidcast_signal()</a></code> has the columns required for the <code>epi_archive</code> format, with <code>issue</code> playing the role of <code>version</code>. We can now use <code><a href="https://rdrr.io/pkg/epiprocess/man/as_epi_archive.html">as_epi_archive()</a></code> to bring it into <code>epi_archive</code> format.</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="no">x</span> <span class="kw">&lt;-</span> <span class="no">dv</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="no">geo_value</span>, <span class="no">time_value</span>, <span class="kw">version</span> <span class="kw">=</span> <span class="no">issue</span>, <span class="kw">percent_cli</span> <span class="kw">=</span> <span class="no">value</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/epiprocess/man/as_epi_archive.html">as_epi_archive</a></span>()

<span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span>(<span class="no">x</span>)</pre></body></html></div>
<pre><code>## [1] "epi_archive" "R6"</code></pre>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="no">x</span>)</pre></body></html></div>
<pre><code>## An `epi_archive` object, with metadata:
## * geo_type  = state
## * time_type = day
## ----------
## * min time value = 2020-06-01
## * max time value = 2021-11-26
## * min version    = 2020-06-06
## * max version    = 2021-11-29
## ----------
## Data archive (stored in DT field): 58574 x 4
## ----------
## Public methods: initialize, print, as_of, slide, clone</code></pre>
<p>An <code>epi_archive</code> is special kind of class called an R6 class. Its primary field is a data table <code>DT</code>, which is of class <code>data.table</code> (from the <code>data.table</code> package), and has columns <code>geo_value</code>, <code>time_value</code>, <code>version</code>, as well as any number of additional columns.</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span>(<span class="no">x</span>$<span class="no">DT</span>)</pre></body></html></div>
<pre><code>## [1] "data.table" "data.frame"</code></pre>
<div class="sourceCode" id="cb11"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">x</span>$<span class="no">DT</span>)</pre></body></html></div>
<pre><code>##    geo_value time_value    version percent_cli
## 1:        ca 2020-06-01 2020-06-06    2.140116
## 2:        ca 2020-06-01 2020-06-07    2.140116
## 3:        ca 2020-06-01 2020-06-08    2.140379
## 4:        ca 2020-06-01 2020-06-09    2.114430
## 5:        ca 2020-06-01 2020-06-10    2.133677
## 6:        ca 2020-06-01 2020-06-11    2.197207</code></pre>
<p>The variables <code>geo_value</code>, <code>time_value</code>, <code>version</code> serve as <strong>key variables</strong> for the data table, as well as any other specified in the metadata (described below). There can only be a single row per unique combination of key variables, and therefore the key variables are critical for figuring out how to generate a snapshot of data from the archive, as of a given version (also described below).</p>
<div class="sourceCode" id="cb13"><html><body><pre class="r"><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setkey.html">key</a></span>(<span class="no">x</span>$<span class="no">DT</span>)</pre></body></html></div>
<pre><code>## [1] "geo_value"  "time_value" "version"</code></pre>
<p>In general, last-observation-carried-forward (LOCF) is used to data in between recorded versions. <strong>A word of caution:</strong> R6 objects, unlike most other objects in R, have reference semantics. An important consequence of this is that objects are not copied when modified.</p>
<div class="sourceCode" id="cb15"><html><body><pre class="r"><span class="no">original_value</span> <span class="kw">&lt;-</span> <span class="no">x</span>$<span class="no">DT</span>$<span class="no">percent_cli</span>[<span class="fl">1</span>]
<span class="no">y</span> <span class="kw">&lt;-</span> <span class="no">x</span> <span class="co"># This DOES NOT make a copy of x</span>
<span class="no">y</span>$<span class="no">DT</span>$<span class="no">percent_cli</span>[<span class="fl">1</span>] <span class="kw">=</span> <span class="fl">0</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">y</span>$<span class="no">DT</span>)</pre></body></html></div>
<pre><code>##    geo_value time_value    version percent_cli
## 1:        ca 2020-06-01 2020-06-06    0.000000
## 2:        ca 2020-06-01 2020-06-07    2.140116
## 3:        ca 2020-06-01 2020-06-08    2.140379
## 4:        ca 2020-06-01 2020-06-09    2.114430
## 5:        ca 2020-06-01 2020-06-10    2.133677
## 6:        ca 2020-06-01 2020-06-11    2.197207</code></pre>
<div class="sourceCode" id="cb17"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">x</span>$<span class="no">DT</span>)</pre></body></html></div>
<pre><code>##    geo_value time_value    version percent_cli
## 1:        ca 2020-06-01 2020-06-06    0.000000
## 2:        ca 2020-06-01 2020-06-07    2.140116
## 3:        ca 2020-06-01 2020-06-08    2.140379
## 4:        ca 2020-06-01 2020-06-09    2.114430
## 5:        ca 2020-06-01 2020-06-10    2.133677
## 6:        ca 2020-06-01 2020-06-11    2.197207</code></pre>
<div class="sourceCode" id="cb19"><html><body><pre class="r"><span class="no">x</span>$<span class="no">DT</span>$<span class="no">percent_cli</span>[<span class="fl">1</span>] <span class="kw">&lt;-</span> <span class="no">original_value</span></pre></body></html></div>
<p>To make a copy, we can use the <code>clone()</code> method for an R6 class, as in <code>y &lt;- x$clone()</code>. You can read more about reference semantics in Hadley Wickham’s <a href="https://adv-r.hadley.nz/r6.html#r6-semantics">Advanced R</a> book.</p>
</div>
<div id="some-details-on-metadata" class="section level2">
<h2 class="hasAnchor">
<a href="#some-details-on-metadata" class="anchor"></a>Some details on metadata</h2>
<p>The following pieces of metadata are included as fields in an <code>epi_archive</code> object:</p>
<ul>
<li>
<code>geo_type</code>: the type for the geo values.</li>
<li>
<code>time_type</code>: the type for the time values.</li>
<li>
<code>additional_metadata</code>: list of additional metadata for the data archive.</li>
</ul>
<p>Metadata for an <code>epi_archive</code> object <code>x</code> can be accessed (and altered) directly, as in <code>x$geo_type</code> or <code>x$time_type</code>, etc. Just like <code><a href="../reference/as_epi_df.html">as_epi_df()</a></code>, the function <code><a href="https://rdrr.io/pkg/epiprocess/man/as_epi_archive.html">as_epi_archive()</a></code> attempts to guess metadata fields when an <code>epi_archive</code> object is instantiated, if they are not explicitly specified in the function call (as it did in the case above).</p>
</div>
<div id="producing-snapshots-in-epi_df-form" class="section level2">
<h2 class="hasAnchor">
<a href="#producing-snapshots-in-epi_df-form" class="anchor"></a>Producing snapshots in <code>epi_df</code> form</h2>
<p>A key method of an <code>epi_archive</code> class is <code>as_of()</code>, which generates a snapshot of the archive in <code>epi_df</code> format. This represents the most up-to-date values of the signal variables as of a given version.</p>
<div class="sourceCode" id="cb20"><html><body><pre class="r"><span class="no">y</span> <span class="kw">&lt;-</span> <span class="no">x</span>$<span class="fu">as_of</span>(<span class="kw">max_version</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span>(<span class="st">"2021-06-01"</span>))
<span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span>(<span class="no">y</span>)</pre></body></html></div>
<pre><code>## [1] "epi_df"     "tbl_df"     "tbl"        "data.frame"</code></pre>
<div class="sourceCode" id="cb22"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">y</span>)</pre></body></html></div>
<pre><code>## # A tibble: 6 × 3
##   geo_value time_value percent_cli
##   &lt;chr&gt;     &lt;date&gt;           &lt;dbl&gt;
## 1 ca        2020-06-01        2.75
## 2 ca        2020-06-02        2.57
## 3 ca        2020-06-03        2.48
## 4 ca        2020-06-04        2.41
## 5 ca        2020-06-05        2.57
## 6 ca        2020-06-06        2.63</code></pre>
<div class="sourceCode" id="cb24"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="no">y</span>$<span class="no">time_value</span>)</pre></body></html></div>
<pre><code>## [1] "2021-05-29"</code></pre>
<div class="sourceCode" id="cb26"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/attributes.html">attributes</a></span>(<span class="no">y</span>)$<span class="no">metadata</span>$<span class="no">as_of</span></pre></body></html></div>
<pre><code>## [1] "2021-06-01"</code></pre>
<p>We can see that the max time value in the <code>epi_df</code> object <code>y</code> that has been generated from the archive is May 29, 2021, even though the specified version date was June 1, 2021. From this we can infer that the doctor’s visits signal was 2 days latent on June 1. Also, we can see that the metadata in the <code>epi_df</code> object has the version date recorded in the <code>as_of</code> field.</p>
<p>Using the maximum of the <code>version</code> column in the underlying data table in an <code>epi_archive</code> object itself generates a snapshot of the latest values of signal variables in the entire archive. The <code>as_of()</code> function issues a warning in this case, since updates to the current version may still come in at a later point in time, due to various reasons like synchronization issues.</p>
<div class="sourceCode" id="cb28"><html><body><pre class="r"><span class="no">z</span> <span class="kw">&lt;-</span> <span class="no">x</span>$<span class="fu">as_of</span>(<span class="kw">max_version</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="no">x</span>$<span class="no">DT</span>$<span class="no">version</span>))</pre></body></html></div>
<pre><code>## Warning: Getting data as of the latest version possible. For a variety of
## reasons, it is possible that we only have a preliminary picture of this version
## (e.g., the upstream source has updated it but we have not seen it due to latency
## in synchronization). Thus, the snapshot that we produce here might not be
## reproducible at a later time (e.g., when the archive has caught up in terms of
## synchronization).</code></pre>
<p>Below, we pull several snapshots from the archive, spaced one month apart. We overlay the corresponding signal curves as colored lines, with the version dates marked by dotted vertical lines, and draw the “finalized” curve in black, from the latest snapshot <code>z</code> that the archive can provide.</p>
<div class="sourceCode" id="cb30"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">purrr</span>)</pre></body></html></div>
<pre><code>## 
## Attaching package: 'purrr'</code></pre>
<pre><code>## The following object is masked from 'package:data.table':
## 
##     transpose</code></pre>
<div class="sourceCode" id="cb33"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">ggplot2</span>)
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html">theme_set</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span>())

<span class="no">self_max</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="no">x</span>$<span class="no">DT</span>$<span class="no">version</span>)
<span class="no">versions</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span>(<span class="st">"2020-06-01"</span>), <span class="no">self_max</span> - <span class="fl">1</span>, <span class="kw">by</span> <span class="kw">=</span> <span class="st">"1 month"</span>)
<span class="no">snapshots</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dfr</a></span>(<span class="no">versions</span>, <span class="kw">function</span>(<span class="no">v</span>) {
  <span class="no">x</span>$<span class="fu">as_of</span>(<span class="kw">max_version</span> <span class="kw">=</span> <span class="no">v</span>) <span class="kw">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">version</span> <span class="kw">=</span> <span class="no">v</span>)
}) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span>(<span class="no">z</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">version</span> <span class="kw">=</span> <span class="no">self_max</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">final</span> <span class="kw">=</span> <span class="no">version</span> <span class="kw">==</span> <span class="no">self_max</span>)

<span class="no">p</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="no">snapshots</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(!<span class="no">final</span>),
            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">time_value</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">percent_cli</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">color</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="no">version</span>))) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">color</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="no">version</span>), <span class="kw">xintercept</span> <span class="kw">=</span> <span class="no">version</span>), <span class="kw">lty</span> <span class="kw">=</span> <span class="fl">2</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span>(~ <span class="no">geo_value</span>, <span class="kw">scales</span> <span class="kw">=</span> <span class="st">"free_y"</span>, <span class="kw">ncol</span> <span class="kw">=</span> <span class="fl">1</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html">scale_x_date</a></span>(<span class="kw">minor_breaks</span> <span class="kw">=</span> <span class="st">"month"</span>, <span class="kw">date_labels</span> <span class="kw">=</span> <span class="st">"%b %y"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="st">"Date"</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="st">"% of doctor's visits with CLI"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="kw">legend.position</span> <span class="kw">=</span> <span class="st">"none"</span>)

<span class="kw pkg">gginnards</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/gginnards/man/delete_layers.html">append_layers</a></span>(
  <span class="no">p</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">snapshots</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="no">final</span>),
               <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">time_value</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">percent_cli</span>),
               <span class="kw">inherit.aes</span> <span class="kw">=</span> <span class="fl">FALSE</span>, <span class="kw">color</span> <span class="kw">=</span> <span class="st">"black"</span>), <span class="kw">pos</span> <span class="kw">=</span> <span class="st">"top"</span>)</pre></body></html></div>
<p><img src="archive_files/figure-html/unnamed-chunk-8-1.png" width="768"></p>
<p>We can see some interesting and highly nontrivial revision behavior: at some points in time the provisional data snapshots grossly underestimate the finalized curve (look in particular at Florida close to the end of 2021), and at others they overestimate it (both states towards the beginning of 2021), though not quite as dramatically. Modeling the revision process, which is often called <em>backfill</em> is an important statistical problem in it of itself.</p>
<p><em>todo: refer to some project/code? perhaps we should think about writing a function in <code>epiprocess</code> or even a separate package?</em></p>
</div>
<div id="sliding-version-aware-computations" class="section level1">
<h1 class="hasAnchor">
<a href="#sliding-version-aware-computations" class="anchor"></a>Sliding version-aware computations</h1>
<p>Next we demonstrate another key method of <code>epi_archive</code>, which is the <code>slide()</code> method. It works just like <code><a href="../reference/epi_slide.html">epi_slide()</a></code> does for an <code>epi_df</code> object, but with one key difference: it performs version-aware computations. That is, for the computation at any given reference time t, it uses only <strong>data that would have been available as of t</strong>.</p>
<p>To demonstrate this, we’re going to …</p>
<div class="sourceCode" id="cb34"><html><body><pre class="r"><span class="no">y</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/covidcast/man/covidcast_signal.html">covidcast_signal</a></span>(<span class="st">"jhu-csse"</span>,
                      <span class="st">"confirmed_7dav_incidence_prop"</span>,
                      <span class="kw">start_day</span> <span class="kw">=</span> <span class="st">"2020-06-01"</span>,
                      <span class="kw">end_day</span> <span class="kw">=</span> <span class="st">"2021-12-01"</span>,
                      <span class="kw">issues</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"2020-06-01"</span>, <span class="st">"2021-12-01"</span>),
                      <span class="kw">geo_type</span> <span class="kw">=</span> <span class="st">"state"</span>,
                      <span class="kw">geo_values</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"ca"</span>, <span class="st">"fl"</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="no">geo_value</span>, <span class="no">time_value</span>, <span class="kw">version</span> <span class="kw">=</span> <span class="no">issue</span>, <span class="kw">case_rates</span> <span class="kw">=</span> <span class="no">value</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/epiprocess/man/as_epi_archive.html">as_epi_archive</a></span>()

<span class="co"># Do a full join at the data.table level</span>
<span class="no">id</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"geo_value"</span>, <span class="st">"time_value"</span>, <span class="st">"version"</span>)
<span class="no">unique_ids</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/duplicated.html">unique</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">x</span>$<span class="no">DT</span>[,<span class="no">..id</span>], <span class="no">y</span>$<span class="no">DT</span>[,<span class="no">..id</span>]))

<span class="no">merge.da</span>
<span class="no">tmp</span> <span class="kw">&lt;-</span> <span class="no">x</span>$<span class="no">DT</span>[<span class="no">y</span>$<span class="no">DT</span>[<span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/J.html">J</a></span>(<span class="no">unique_ids</span>)]]
<span class="no">x</span>$<span class="no">DT</span> <span class="kw">&lt;-</span> <span class="no">x</span>$<span class="no">DT</span>[<span class="no">y</span>$<span class="no">DT</span>, ] <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/merge.html">merge</a></span>(<span class="no">zz</span>, <span class="kw">all</span> <span class="kw">=</span> <span class="fl">TRUE</span>) <span class="kw">%&gt;%</span>
  <span class="co">#table.express::group_by(geo_value, version) %&gt;%</span>
  <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/nafill.html">setnafill</a></span>(<span class="kw">type</span> <span class="kw">=</span> <span class="st">"locf"</span>, <span class="co"># Fill according to LOCF</span>
            <span class="kw">cols</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"percent_cli"</span>, <span class="st">"case_rates"</span>))

<span class="no">x</span>$<span class="fu">as_of</span>(<span class="no">self_max</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">time_value</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">y</span> <span class="kw">=</span> <span class="no">percent_cli</span>), <span class="kw">col</span> <span class="kw">=</span> <span class="st">"red"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">y</span> <span class="kw">=</span> <span class="no">case_rates</span> / <span class="fl">1000</span>), <span class="kw">col</span> <span class="kw">=</span> <span class="st">"blue"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span>(~ <span class="no">geo_value</span>, <span class="kw">scales</span> <span class="kw">=</span> <span class="st">"free_y"</span>, <span class="kw">ncol</span> <span class="kw">=</span> <span class="fl">1</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html">scale_x_date</a></span>(<span class="kw">minor_breaks</span> <span class="kw">=</span> <span class="st">"month"</span>, <span class="kw">date_labels</span> <span class="kw">=</span> <span class="st">"%b %y"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="st">"Date"</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="st">""</span>)</pre></body></html></div>
<p>[about training on finalized versus honest data…]</p>
<p>This makes a bigger deal for some signals than others; for reported COVID-19 cases, data revisions are most often made in the form of big spikes or drops; for other signals (like those based on medical insurance claims), the revision process can be more regular and incremental.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Logan Brooks, Evan Ray, Ryan Tibshirani.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
