<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Work with archive objects and data revisions • epiprocess</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Work with archive objects and data revisions">
<meta property="og:description" content="epiprocess">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">epiprocess</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/epiprocess.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/slide.html">Slide a computation over signal values</a>
    </li>
    <li>
      <a href="../articles/growth_rate.html">Estimate growth rates in signals</a>
    </li>
    <li>
      <a href="../articles/correlation.html">Correlate signals over space and time</a>
    </li>
    <li>
      <a href="../articles/aggregation.html">Aggregate signals over space and time</a>
    </li>
    <li>
      <a href="../articles/outliers.html">Detect and correct outliers in signals</a>
    </li>
    <li>
      <a href="../articles/archive.html">Work with archive objects and data revisions</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/cmu-delphi/epiprocess/tree/main/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="archive_files/header-attrs-2.10/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Work with archive objects and data revisions</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/cmu-delphi/epiprocess/blob/main/vignettes/archive.Rmd"><code>vignettes/archive.Rmd</code></a></small>
      <div class="hidden name"><code>archive.Rmd</code></div>

    </div>

    
    
<p>In addition to the <code>epi_df</code> data structure, which we have been working with all along in these vignettes, the <code>epiprocess</code> package has a companion structure called <code>epi_archive</code>. In comparison to an <code>epi_df</code> object, which can be seen as storing a single snapshot of a data set with the most up-to-date signal values as of some given time, an <code>epi_archive</code> object stores the full version history of a data set. Many signals of interest for epidemiological tracking are subject to revision (some more than others), and paying attention to data revisions can be important for all sorts of downstream data analysis and modeling tasks.</p>
<p>This vignette walks through working with <code>epi_archive</code> objects and demonstrates some of their key functionality. We’ll work with a signal on the percentage of doctor’s visits with CLI (COVID-like illness) computed from medical insurance claims, available through the <a href="https://cmu-delphi.github.io/delphi-epidata/api/covidcast.html/">COVIDcast API</a>. This signal is subject to very heavy and regular revision; you can read more about it on its <a href="https://cmu-delphi.github.io/delphi-epidata/api/covidcast-signals/doctor-visits.html">API documentation page</a>.</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">covidcast</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">epiprocess</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">data.table</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">dplyr</span>)

<span class="no">dv</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/covidcast/man/covidcast_signal.html">covidcast_signal</a></span>(<span class="st">"doctor-visits"</span>,
                       <span class="st">"smoothed_adj_cli"</span>,
                       <span class="kw">start_day</span> <span class="kw">=</span> <span class="st">"2020-06-01"</span>,
                       <span class="kw">end_day</span> <span class="kw">=</span> <span class="st">"2021-12-01"</span>,
                       <span class="kw">issues</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"2020-06-01"</span>, <span class="st">"2021-12-01"</span>),
                       <span class="kw">geo_type</span> <span class="kw">=</span> <span class="st">"state"</span>,
                       <span class="kw">geo_values</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"ca"</span>, <span class="st">"fl"</span>))</pre></body></html></div>
<pre><code>## Warning: Data not fetched for the following days: 2021-11-27, 2021-11-28,
## 2021-11-29, 2021-11-30, 2021-12-01</code></pre>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">dv</span>)</pre></body></html></div>
<pre><code>##  [1] "data_source"         "signal"              "geo_value"          
##  [4] "time_value"          "source"              "geo_type"           
##  [7] "time_type"           "issue"               "lag"                
## [10] "missing_value"       "missing_stderr"      "missing_sample_size"
## [13] "value"               "stderr"              "sample_size"</code></pre>
<div id="getting-data-into-epi_archive-format" class="section level2">
<h2 class="hasAnchor">
<a href="#getting-data-into-epi_archive-format" class="anchor"></a>Getting data into <code>epi_archive</code> format</h2>
<p>An <code><a href="../reference/epi_archive.html">epi_archive</a></code> object can be constructed from a data frame, data table, or tibble, provided that it has (at least) the following columns:</p>
<ul>
<li>
<code>geo_value</code>: the geographic value associated with each row of measurements.</li>
<li>
<code>time_value</code>: the time value associated with each row of measurements.</li>
<li>
<code>version</code>: the time value specifying the version for each row of measurements. For example, if in a given row the <code>version</code> is January 15, 2022 and <code>time_value</code> is January 14, 2022, then this row contains the measurements of the data for January 14, 2022 that were available one day later.</li>
</ul>
<p>As we can see from the above, the data frame returned by <code><a href="https://rdrr.io/pkg/covidcast/man/covidcast_signal.html">covidcast::covidcast_signal()</a></code> has the columns required for the <code>epi_archive</code> format, with <code>issue</code> playing the role of <code>version</code>. We can now use <code><a href="../reference/as_epi_archive.html">as_epi_archive()</a></code> to bring it into <code>epi_archive</code> format.</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="no">x</span> <span class="kw">&lt;-</span> <span class="no">dv</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="no">geo_value</span>, <span class="no">time_value</span>, <span class="kw">version</span> <span class="kw">=</span> <span class="no">issue</span>, <span class="kw">percent_cli</span> <span class="kw">=</span> <span class="no">value</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/as_epi_archive.html">as_epi_archive</a></span>()

<span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span>(<span class="no">x</span>)</pre></body></html></div>
<pre><code>## [1] "epi_archive" "R6"</code></pre>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="no">x</span>)</pre></body></html></div>
<pre><code>## An `epi_archive` object, with metadata:
## * geo_type  = state
## * time_type = day
## ----------
## * min time value = 2020-06-01
## * max time value = 2021-11-26
## * min version    = 2020-06-06
## * max version    = 2021-11-29
## ----------
## Data archive (stored in DT field): 58574 x 4
## ----------
## Public methods: initialize, print, as_of, merge, slide, clone</code></pre>
<p>An <code>epi_archive</code> is special kind of class called an R6 class. Its primary field is a data table <code>DT</code>, which is of class <code>data.table</code> (from the <code>data.table</code> package), and has columns <code>geo_value</code>, <code>time_value</code>, <code>version</code>, as well as any number of additional columns.</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span>(<span class="no">x</span>$<span class="no">DT</span>)</pre></body></html></div>
<pre><code>## [1] "data.table" "data.frame"</code></pre>
<div class="sourceCode" id="cb11"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">x</span>$<span class="no">DT</span>)</pre></body></html></div>
<pre><code>##    geo_value time_value    version percent_cli
## 1:        ca 2020-06-01 2020-06-06    2.140116
## 2:        ca 2020-06-01 2020-06-07    2.140116
## 3:        ca 2020-06-01 2020-06-08    2.140379
## 4:        ca 2020-06-01 2020-06-09    2.114430
## 5:        ca 2020-06-01 2020-06-10    2.133677
## 6:        ca 2020-06-01 2020-06-11    2.197207</code></pre>
<p>The variables <code>geo_value</code>, <code>time_value</code>, <code>version</code> serve as <strong>key variables</strong> for the data table, as well as any other specified in the metadata (described below). There can only be a single row per unique combination of key variables, and therefore the key variables are critical for figuring out how to generate a snapshot of data from the archive, as of a given version (also described below).</p>
<div class="sourceCode" id="cb13"><html><body><pre class="r"><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setkey.html">key</a></span>(<span class="no">x</span>$<span class="no">DT</span>)</pre></body></html></div>
<pre><code>## [1] "geo_value"  "time_value" "version"</code></pre>
<p>In general, last observation carried forward (LOCF) is used to data in between recorded versions. <strong>A word of caution:</strong> R6 objects, unlike most other objects in R, have reference semantics. An important consequence of this is that objects are not copied when modified.</p>
<div class="sourceCode" id="cb15"><html><body><pre class="r"><span class="no">original_value</span> <span class="kw">&lt;-</span> <span class="no">x</span>$<span class="no">DT</span>$<span class="no">percent_cli</span>[<span class="fl">1</span>]
<span class="no">y</span> <span class="kw">&lt;-</span> <span class="no">x</span> <span class="co"># This DOES NOT make a copy of x</span>
<span class="no">y</span>$<span class="no">DT</span>$<span class="no">percent_cli</span>[<span class="fl">1</span>] <span class="kw">=</span> <span class="fl">0</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">y</span>$<span class="no">DT</span>)</pre></body></html></div>
<pre><code>##    geo_value time_value    version percent_cli
## 1:        ca 2020-06-01 2020-06-06    0.000000
## 2:        ca 2020-06-01 2020-06-07    2.140116
## 3:        ca 2020-06-01 2020-06-08    2.140379
## 4:        ca 2020-06-01 2020-06-09    2.114430
## 5:        ca 2020-06-01 2020-06-10    2.133677
## 6:        ca 2020-06-01 2020-06-11    2.197207</code></pre>
<div class="sourceCode" id="cb17"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">x</span>$<span class="no">DT</span>)</pre></body></html></div>
<pre><code>##    geo_value time_value    version percent_cli
## 1:        ca 2020-06-01 2020-06-06    0.000000
## 2:        ca 2020-06-01 2020-06-07    2.140116
## 3:        ca 2020-06-01 2020-06-08    2.140379
## 4:        ca 2020-06-01 2020-06-09    2.114430
## 5:        ca 2020-06-01 2020-06-10    2.133677
## 6:        ca 2020-06-01 2020-06-11    2.197207</code></pre>
<div class="sourceCode" id="cb19"><html><body><pre class="r"><span class="no">x</span>$<span class="no">DT</span>$<span class="no">percent_cli</span>[<span class="fl">1</span>] <span class="kw">&lt;-</span> <span class="no">original_value</span></pre></body></html></div>
<p>To make a copy, we can use the <code>clone()</code> method for an R6 class, as in <code>y &lt;- x$clone()</code>. You can read more about reference semantics in Hadley Wickham’s <a href="https://adv-r.hadley.nz/r6.html#r6-semantics">Advanced R</a> book.</p>
</div>
<div id="some-details-on-metadata" class="section level2">
<h2 class="hasAnchor">
<a href="#some-details-on-metadata" class="anchor"></a>Some details on metadata</h2>
<p>The following pieces of metadata are included as fields in an <code>epi_archive</code> object:</p>
<ul>
<li>
<code>geo_type</code>: the type for the geo values.</li>
<li>
<code>time_type</code>: the type for the time values.</li>
<li>
<code>additional_metadata</code>: list of additional metadata for the data archive.</li>
</ul>
<p>Metadata for an <code>epi_archive</code> object <code>x</code> can be accessed (and altered) directly, as in <code>x$geo_type</code> or <code>x$time_type</code>, etc. Just like <code><a href="../reference/as_epi_df.html">as_epi_df()</a></code>, the function <code><a href="../reference/as_epi_archive.html">as_epi_archive()</a></code> attempts to guess metadata fields when an <code>epi_archive</code> object is instantiated, if they are not explicitly specified in the function call (as it did in the case above).</p>
</div>
<div id="producing-snapshots-in-epi_df-form" class="section level2">
<h2 class="hasAnchor">
<a href="#producing-snapshots-in-epi_df-form" class="anchor"></a>Producing snapshots in <code>epi_df</code> form</h2>
<p>A key method of an <code>epi_archive</code> class is <code>as_of()</code>, which generates a snapshot of the archive in <code>epi_df</code> format. This represents the most up-to-date values of the signal variables as of a given version. This can be accessed via <code>x$as_of()</code> for an <code>epi_archive</code> object <code>x</code>, but the package also provides a simple wrapper function <code><a href="../reference/epix_as_of.html">epix_as_of()</a></code> since this is likely a more familiar interface for users not familiar with R6 (or object-oriented programming).</p>
<div class="sourceCode" id="cb20"><html><body><pre class="r"><span class="no">x_snapshot</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/epix_as_of.html">epix_as_of</a></span>(<span class="no">x</span>, <span class="kw">max_version</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span>(<span class="st">"2021-06-01"</span>))
<span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span>(<span class="no">x_snapshot</span>)</pre></body></html></div>
<pre><code>## [1] "epi_df"     "tbl_df"     "tbl"        "data.frame"</code></pre>
<div class="sourceCode" id="cb22"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">x_snapshot</span>)</pre></body></html></div>
<pre><code>## # A tibble: 6 × 3
##   geo_value time_value percent_cli
##   &lt;chr&gt;     &lt;date&gt;           &lt;dbl&gt;
## 1 ca        2020-06-01        2.75
## 2 ca        2020-06-02        2.57
## 3 ca        2020-06-03        2.48
## 4 ca        2020-06-04        2.41
## 5 ca        2020-06-05        2.57
## 6 ca        2020-06-06        2.63</code></pre>
<div class="sourceCode" id="cb24"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="no">x_snapshot</span>$<span class="no">time_value</span>)</pre></body></html></div>
<pre><code>## [1] "2021-05-29"</code></pre>
<div class="sourceCode" id="cb26"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/attributes.html">attributes</a></span>(<span class="no">x_snapshot</span>)$<span class="no">metadata</span>$<span class="no">as_of</span></pre></body></html></div>
<pre><code>## [1] "2021-06-01"</code></pre>
<p>We can see that the max time value in the <code>epi_df</code> object <code>x_snapshot</code> that was generated from the archive is May 29, 2021, even though the specified version date was June 1, 2021. From this we can infer that the doctor’s visits signal was 2 days latent on June 1. Also, we can see that the metadata in the <code>epi_df</code> object has the version date recorded in the <code>as_of</code> field.</p>
<p>Using the maximum of the <code>version</code> column in the underlying data table in an <code>epi_archive</code> object itself generates a snapshot of the latest values of signal variables in the entire archive. The <code><a href="../reference/epix_as_of.html">epix_as_of()</a></code> function issues a warning in this case, since updates to the current version may still come in at a later point in time, due to various reasons, such as synchronization issues.</p>
<div class="sourceCode" id="cb28"><html><body><pre class="r"><span class="no">x_latest</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/epix_as_of.html">epix_as_of</a></span>(<span class="no">x</span>, <span class="kw">max_version</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="no">x</span>$<span class="no">DT</span>$<span class="no">version</span>))</pre></body></html></div>
<pre><code>## Warning: Getting data as of the latest version possible. For a variety of
## reasons, it is possible that we only have a preliminary picture of this version
## (e.g., the upstream source has updated it but we have not seen it due to latency
## in synchronization). Thus, the snapshot that we produce here might not be
## reproducible at a later time (e.g., when the archive has caught up in terms of
## synchronization).</code></pre>
<p>Below, we pull several snapshots from the archive, spaced one month apart. We overlay the corresponding signal curves as colored lines, with the version dates marked by dotted vertical lines, and draw the latest curve in black (from the latest snapshot <code>x_latest</code> that the archive can provide).</p>
<div class="sourceCode" id="cb30"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">purrr</span>)</pre></body></html></div>
<pre><code>## 
## Attaching package: 'purrr'</code></pre>
<pre><code>## The following object is masked from 'package:data.table':
## 
##     transpose</code></pre>
<div class="sourceCode" id="cb33"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">ggplot2</span>)
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html">theme_set</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span>())

<span class="no">self_max</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="no">x</span>$<span class="no">DT</span>$<span class="no">version</span>)
<span class="no">versions</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span>(<span class="st">"2020-06-01"</span>), <span class="no">self_max</span> - <span class="fl">1</span>, <span class="kw">by</span> <span class="kw">=</span> <span class="st">"1 month"</span>)
<span class="no">snapshots</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dfr</a></span>(<span class="no">versions</span>, <span class="kw">function</span>(<span class="no">v</span>) {
  <span class="fu"><a href="../reference/epix_as_of.html">epix_as_of</a></span>(<span class="no">x</span>, <span class="kw">max_version</span> <span class="kw">=</span> <span class="no">v</span>) <span class="kw">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">version</span> <span class="kw">=</span> <span class="no">v</span>)
}) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span>(<span class="no">x_latest</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">version</span> <span class="kw">=</span> <span class="no">self_max</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">latest</span> <span class="kw">=</span> <span class="no">version</span> <span class="kw">==</span> <span class="no">self_max</span>)

<span class="no">p</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="no">snapshots</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(!<span class="no">latest</span>),
            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">time_value</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">percent_cli</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">color</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="no">version</span>))) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">color</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="no">version</span>), <span class="kw">xintercept</span> <span class="kw">=</span> <span class="no">version</span>), <span class="kw">lty</span> <span class="kw">=</span> <span class="fl">2</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span>(~ <span class="no">geo_value</span>, <span class="kw">scales</span> <span class="kw">=</span> <span class="st">"free_y"</span>, <span class="kw">ncol</span> <span class="kw">=</span> <span class="fl">1</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html">scale_x_date</a></span>(<span class="kw">minor_breaks</span> <span class="kw">=</span> <span class="st">"month"</span>, <span class="kw">date_labels</span> <span class="kw">=</span> <span class="st">"%b %y"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="st">"Date"</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="st">"% of doctor's visits with CLI"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="kw">legend.position</span> <span class="kw">=</span> <span class="st">"none"</span>)

<span class="kw pkg">gginnards</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/gginnards/man/delete_layers.html">append_layers</a></span>(
  <span class="no">p</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">snapshots</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="no">latest</span>),
               <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">time_value</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">percent_cli</span>),
               <span class="kw">inherit.aes</span> <span class="kw">=</span> <span class="fl">FALSE</span>, <span class="kw">color</span> <span class="kw">=</span> <span class="st">"black"</span>), <span class="kw">pos</span> <span class="kw">=</span> <span class="st">"top"</span>)</pre></body></html></div>
<p><img src="archive_files/figure-html/unnamed-chunk-8-1.png" width="768"></p>
<p>We can see some interesting and highly nontrivial revision behavior: at some points in time the provisional data snapshots grossly underestimate the latest curve (look in particular at Florida close to the end of 2021), and at others they overestimate it (both states towards the beginning of 2021), though not quite as dramatically. Modeling the revision process, which is often called <em>backfill modeling</em>, is an important statistical problem in it of itself.</p>
<!-- todo: refer to some project/code? perhaps we should think about writing a
 function in `epiprocess` or even a separate package? -->
</div>
<div id="merging-epi_archive-objects" class="section level2">
<h2 class="hasAnchor">
<a href="#merging-epi_archive-objects" class="anchor"></a>Merging <code>epi_archive</code> objects</h2>
<p>Now we demonstrate how to merge the underlying data tables in two <code>epi_archive</code> objects together. The <code>epi_archive</code> class provides a method <code><a href="https://Rdatatable.gitlab.io/data.table/reference/merge.html">merge()</a></code> precisely for this purpose. The wrapper function is called <code><a href="../reference/epix_merge.html">epix_merge()</a></code>; as before, this is just offered as a matter of convenience/familiarity for some users. Below we merge the working <code>epi_archive</code> of versioned percentage CLI from outpatient visits to another one of versioned COVID-19 case reporting data, which we fetch the from the <a href="https://cmu-delphi.github.io/delphi-epidata/api/covidcast.html/">COVIDcast API</a>, on the rate scale (counts per 100,000 people in the population).</p>
<p>When merging archives, we typically want to perform a <em>full join</em>, otherwise we will be throwing out versioned data from one table or the other. This is accomplished by setting <code>all = TRUE</code> in the call to <code><a href="../reference/epix_merge.html">epix_merge()</a></code>. Furthermore, this function provides an option for filling <code>NA</code> values via LOCF by setting <code>locf = TRUE</code>. In general, unless two data tables have the exact same pattern of updates, we will get <code>NA</code> values in the signals after performing a full join. Because the original data archives are stored in LOCF (last observation carried forward) format in the first place, it generally makes sense to perform <code>NA</code> filling after merging using LOCF. Therefore <code>locf = TRUE</code> is the default.</p>
<div class="sourceCode" id="cb34"><html><body><pre class="r"><span class="no">y</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/covidcast/man/covidcast_signal.html">covidcast_signal</a></span>(<span class="st">"jhu-csse"</span>,
                      <span class="st">"confirmed_7dav_incidence_prop"</span>,
                      <span class="kw">start_day</span> <span class="kw">=</span> <span class="st">"2020-06-01"</span>,
                      <span class="kw">end_day</span> <span class="kw">=</span> <span class="st">"2021-12-01"</span>,
                      <span class="kw">issues</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"2020-06-01"</span>, <span class="st">"2021-12-01"</span>),
                      <span class="kw">geo_type</span> <span class="kw">=</span> <span class="st">"state"</span>,
                      <span class="kw">geo_values</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"ca"</span>, <span class="st">"fl"</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="no">geo_value</span>, <span class="no">time_value</span>, <span class="kw">version</span> <span class="kw">=</span> <span class="no">issue</span>, <span class="kw">case_rates</span> <span class="kw">=</span> <span class="no">value</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/as_epi_archive.html">as_epi_archive</a></span>()</pre></body></html></div>
<pre><code>## Fetched day 2020-06-01 to 2021-12-01: num_entries = 12105</code></pre>
<pre><code>## Warning: Data not fetched for the following days: 2021-12-01</code></pre>
<div class="sourceCode" id="cb37"><html><body><pre class="r"><span class="fu"><a href="../reference/epix_merge.html">epix_merge</a></span>(<span class="no">x</span>, <span class="no">y</span>, <span class="kw">all</span> <span class="kw">=</span> <span class="fl">TRUE</span>)
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="no">x</span>)</pre></body></html></div>
<pre><code>## An `epi_archive` object, with metadata:
## * geo_type  = state
## * time_type = day
## ----------
## * min time value = 2020-06-01
## * max time value = 2021-11-30
## * min version    = 2020-06-02
## * max version    = 2021-12-01
## ----------
## Data archive (stored in DT field): 66221 x 5
## ----------
## Public methods: initialize, print, as_of, merge, slide, clone</code></pre>
<div class="sourceCode" id="cb39"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">x</span>$<span class="no">DT</span>)</pre></body></html></div>
<pre><code>##    geo_value time_value    version percent_cli case_rates
## 1:        ca 2020-06-01 2020-06-02          NA   6.628329
## 2:        ca 2020-06-01 2020-06-06    2.140116   6.628329
## 3:        ca 2020-06-01 2020-06-07    2.140116   6.628329
## 4:        ca 2020-06-01 2020-06-08    2.140379   6.628329
## 5:        ca 2020-06-01 2020-06-09    2.114430   6.628329
## 6:        ca 2020-06-01 2020-06-10    2.133677   6.628329</code></pre>
<p>Importantly, as we can see, the way <code><a href="../reference/epix_merge.html">epix_merge()</a></code> works is that it <strong>overwrites</strong> the data table in the first <code>epi_archive</code> object <code>x</code> by the merged data table.</p>
</div>
<div id="sliding-version-aware-computations" class="section level2">
<h2 class="hasAnchor">
<a href="#sliding-version-aware-computations" class="anchor"></a>Sliding version-aware computations</h2>
<p>Lastly, we demonstrate another key method of the <code>epi_archive</code> class, which is the <code>slide()</code> method. It works just like <code><a href="../reference/epi_slide.html">epi_slide()</a></code> does for an <code>epi_df</code> object, but with one key difference: it performs version-aware computations. That is, for the computation at any given reference time t, it only uses <strong>data that would have been available as of t</strong>. The wrapper function is called <code><a href="../reference/epix_slide.html">epix_slide()</a></code>; again, this is just for convenience/familiarity—and its interface is purposely designed mirror that of <code><a href="../reference/epi_slide.html">epi_slide()</a></code> for <code>epi_df</code> objects.</p>
<p>For the demonstration, we’ll revisit the forecasting example from the <a href="https://cmu-delphi.github.io/epiprocess/articles/slide.html">slide vignette</a>, and now we’ll build a forecaster that uses properly-versioned data (that would have been available in real-time) to forecast future COVID-19 case rates from current and past COVID-19 case rates, as well as current and past values of the outpatient CLI signal from medical claims. We’ll extend the <code>prob_ar()</code> function from the slide vignette to accomodate exogenous variables in the autoregressive model, which is often referred to as an ARX model.</p>
<div class="sourceCode" id="cb41"><html><body><pre class="r"><span class="no">prob_arx</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">x</span>, <span class="no">y</span>, <span class="no">lags</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>, <span class="fl">7</span>, <span class="fl">14</span>), <span class="no">ahead</span> <span class="kw">=</span> <span class="fl">7</span>, <span class="no">min_train_window</span> <span class="kw">=</span> <span class="fl">20</span>,
                     <span class="no">lower_level</span> <span class="kw">=</span> <span class="fl">0.05</span>, <span class="no">upper_level</span> <span class="kw">=</span> <span class="fl">0.95</span>, <span class="no">symmetrize</span> <span class="kw">=</span> <span class="fl">TRUE</span>,
                     <span class="no">nonneg</span> <span class="kw">=</span> <span class="fl">TRUE</span>) {
  <span class="co"># Return NA if insufficient training data</span>
  <span class="kw">if</span> (<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">y</span>) <span class="kw">&lt;</span> <span class="no">min_train_window</span> + <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="no">lags</span>) + <span class="no">ahead</span>) {
    <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">point</span> <span class="kw">=</span> <span class="fl">NA</span>, <span class="kw">lower</span> <span class="kw">=</span> <span class="fl">NA</span>, <span class="kw">upper</span> <span class="kw">=</span> <span class="fl">NA</span>))
  }

  <span class="co"># Useful transformations</span>
  <span class="kw">if</span> (!<span class="fu"><a href="https://rdrr.io/r/base/missing.html">missing</a></span>(<span class="no">x</span>)) <span class="no">x</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="no">x</span>, <span class="no">y</span>)
  <span class="kw">else</span> <span class="no">x</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="no">y</span>)
  <span class="kw">if</span> (!<span class="fu"><a href="https://rdrr.io/r/base/list.html">is.list</a></span>(<span class="no">lags</span>)) <span class="no">lags</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="no">lags</span>)
  <span class="no">lags</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="no">lags</span>, <span class="kw">length.out</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span>(<span class="no">x</span>))

  <span class="co"># Build features and response for the AR model, and then fit it</span>
  <span class="no">dat</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span>(
    <span class="no">data.frame</span>,
    <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span>( <span class="co"># Below we loop through and build the lagged features</span>
      <span class="kw pkg">purrr</span><span class="kw ns">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span>(<span class="fl">1</span>:<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span>(<span class="no">x</span>), <span class="kw">function</span>(<span class="no">i</span>) {
        <span class="kw pkg">purrr</span><span class="kw ns">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span>(<span class="no">lags</span><span class="kw">[[</span><span class="no">i</span>]], <span class="kw">function</span>(<span class="no">lag</span>) <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span>(<span class="no">x</span>[,<span class="no">i</span>], <span class="kw">n</span> <span class="kw">=</span> <span class="no">lag</span>))
      }),
      <span class="kw">recursive</span> <span class="kw">=</span> <span class="fl">FALSE</span>
    )
  )
  <span class="no">dat</span>$<span class="no">y</span> <span class="kw">&lt;-</span> <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lead</a></span>(<span class="no">y</span>, <span class="kw">n</span> <span class="kw">=</span> <span class="no">ahead</span>)
  <span class="no">obj</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span>(<span class="no">y</span> ~ <span class="no">.</span>, <span class="kw">data</span> <span class="kw">=</span> <span class="no">dat</span>)

  <span class="co"># Use LOCF to fill NAs in the latest feature values, make a prediction</span>
  <span class="kw pkg">data.table</span><span class="kw ns">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/nafill.html">setnafill</a></span>(<span class="no">dat</span>, <span class="kw">type</span> <span class="kw">=</span> <span class="st">"locf"</span>)
  <span class="no">point</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(<span class="no">obj</span>, <span class="kw">newdata</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">tail</a></span>(<span class="no">dat</span>, <span class="fl">1</span>))

  <span class="co"># Compute a band </span>
  <span class="no">r</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span>(<span class="no">obj</span>)
  <span class="no">s</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/fifelse.html">ifelse</a></span>(<span class="no">symmetrize</span>, -<span class="fl">1</span>, <span class="fl">NA</span>) <span class="co"># Should the residuals be symmetrized?</span>
  <span class="no">q</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">r</span>, <span class="no">s</span> * <span class="no">r</span>), <span class="kw">probs</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">lower_level</span>, <span class="no">upper_level</span>), <span class="kw">na.rm</span> <span class="kw">=</span> <span class="fl">TRUE</span>)
  <span class="no">lower</span> <span class="kw">&lt;-</span> <span class="no">point</span> + <span class="no">q</span>[<span class="fl">1</span>]
  <span class="no">upper</span> <span class="kw">&lt;-</span> <span class="no">point</span> + <span class="no">q</span>[<span class="fl">2</span>]

  <span class="co"># Clip at zero if we need to, then return</span>
  <span class="kw">if</span> (<span class="no">nonneg</span>) {
    <span class="no">point</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="no">point</span>, <span class="fl">0</span>)
    <span class="no">lower</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="no">lower</span>, <span class="fl">0</span>)
    <span class="no">upper</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="no">upper</span>, <span class="fl">0</span>)
  }
  <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">point</span> <span class="kw">=</span> <span class="no">point</span>, <span class="kw">lower</span> <span class="kw">=</span> <span class="no">lower</span>, <span class="kw">upper</span> <span class="kw">=</span> <span class="no">upper</span>))
}</pre></body></html></div>
<p>Next we slide this forecaster over the working <code>epi_archive</code> object, in order to forecast COVID-19 case rates 7 days into the future.</p>
<div class="sourceCode" id="cb42"><html><body><pre class="r"><span class="no">fc_time_values</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span>(<span class="st">"2020-08-01"</span>),
                     <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span>(<span class="st">"2021-12-01"</span>),
                     <span class="kw">by</span> <span class="kw">=</span> <span class="st">"1 month"</span>)

<span class="no">z</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/epix_slide.html">epix_slide</a></span>(<span class="no">x</span>, <span class="kw">fc</span> <span class="kw">=</span> <span class="fu">prob_arx</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">percent_cli</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">case_rates</span>), <span class="kw">n</span> <span class="kw">=</span> <span class="fl">120</span>,
                <span class="kw">ref_time_values</span> <span class="kw">=</span> <span class="no">fc_time_values</span>, <span class="kw">group_by</span> <span class="kw">=</span> <span class="no">geo_value</span>)

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">z</span>, <span class="fl">10</span>)</pre></body></html></div>
<pre><code>## # A tibble: 10 × 5
##    geo_value time_value fc_point fc_lower fc_upper
##    &lt;chr&gt;     &lt;date&gt;        &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
##  1 ca        2020-08-01     22.9    21.4      24.3
##  2 fl        2020-08-01     36.3    31.4      41.3
##  3 ca        2020-09-01     22.7    20.0      25.5
##  4 fl        2020-09-01     15.7    10.5      20.9
##  5 ca        2020-10-01     12.9     9.47     16.3
##  6 fl        2020-10-01     14.3     8.61     20.1
##  7 ca        2020-11-01     13.7    11.3      16.2
##  8 fl        2020-11-01     20.9    17.7      24.1
##  9 ca        2020-12-01     61.3    58.3      64.3
## 10 fl        2020-12-01     60.7    57.0      64.3</code></pre>
<p>We get back a tibble <code>z</code> with the grouping variables (here geo value), the time values, and three columns <code>fc_point</code>, <code>fc_lower</code>, and <code>fc_upper</code> produced by the slide computation that correspond to the point forecast, and the lower and upper endpoints of the 95% prediction band, respectively. (If instead we had set <code>as_list_col = TRUE</code> in the call to <code><a href="../reference/epix_slide.html">epix_slide()</a></code>, then we would have gotten a list column <code>fc</code>, where each element of <code>fc</code> is a data frame with named columns <code>point</code>, <code>lower</code>, and <code>upper</code>.)</p>
<p>On the whole, <code><a href="../reference/epix_slide.html">epix_slide()</a></code> works similarly to <code><a href="../reference/epix_slide.html">epix_slide()</a></code>, though there are a few notable differences, even apart from the version-aware aspect. You can read the documentation for <code><a href="../reference/epix_slide.html">epix_slide()</a></code> for details.</p>
<p>We finish off by comparing version-aware and version-unaware forecasts at various points in time and forecast horizons. The former will come from applying <code><a href="../reference/epix_slide.html">epix_slide()</a></code> to the <code>epi_archive</code> object <code>x</code>, and the latter from applying <code><a href="../reference/epi_slide.html">epi_slide()</a></code> to the latest snapshot of the data <code>x_latest</code>.</p>
<div class="sourceCode" id="cb44"><html><body><pre class="r"><span class="no">x_latest</span> <span class="kw">=</span> <span class="fu"><a href="../reference/epix_as_of.html">epix_as_of</a></span>(<span class="no">x</span>, <span class="kw">max_version</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="no">x</span>$<span class="no">DT</span>$<span class="no">version</span>))

<span class="no">k_week_ahead</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">x</span>, <span class="no">ahead</span> <span class="kw">=</span> <span class="fl">7</span>, <span class="no">as_of</span> <span class="kw">=</span> <span class="fl">TRUE</span>) {
  <span class="kw">if</span> (<span class="no">as_of</span>) {
    <span class="no">x</span> <span class="kw">%&gt;%</span>
      <span class="fu"><a href="../reference/epix_slide.html">epix_slide</a></span>(<span class="kw">fc</span> <span class="kw">=</span> <span class="fu">prob_arx</span>(<span class="no">percent_cli</span>, <span class="no">case_rates</span>, <span class="kw">ahead</span> <span class="kw">=</span> <span class="no">ahead</span>), <span class="kw">n</span> <span class="kw">=</span> <span class="fl">120</span>,
                 <span class="kw">ref_time_values</span> <span class="kw">=</span> <span class="no">fc_time_values</span>, <span class="kw">group_by</span> <span class="kw">=</span> <span class="no">geo_value</span>) <span class="kw">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">target_date</span> <span class="kw">=</span> <span class="no">time_value</span> + <span class="no">ahead</span>, <span class="kw">as_of</span> <span class="kw">=</span> <span class="fl">TRUE</span>)
  }
  <span class="kw">else</span> {
    <span class="no">x_latest</span> <span class="kw">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(<span class="no">geo_value</span>) <span class="kw">%&gt;%</span>
      <span class="fu"><a href="../reference/epi_slide.html">epi_slide</a></span>(<span class="kw">fc</span> <span class="kw">=</span> <span class="fu">prob_arx</span>(<span class="no">percent_cli</span>, <span class="no">case_rates</span>, <span class="kw">ahead</span> <span class="kw">=</span> <span class="no">ahead</span>), <span class="kw">n</span> <span class="kw">=</span> <span class="fl">120</span>,
                <span class="kw">ref_time_values</span> <span class="kw">=</span> <span class="no">fc_time_values</span>) <span class="kw">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">target_date</span> <span class="kw">=</span> <span class="no">time_value</span> + <span class="no">ahead</span>, <span class="kw">as_of</span> <span class="kw">=</span> <span class="fl">FALSE</span>)
  }
}

<span class="co"># First generate the forecasts, and bind them together</span>
<span class="no">fc</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span>(<span class="fu">k_week_ahead</span>(<span class="no">x</span>, <span class="kw">ahead</span> <span class="kw">=</span> <span class="fl">7</span>, <span class="kw">as_of</span> <span class="kw">=</span> <span class="fl">TRUE</span>),
                <span class="fu">k_week_ahead</span>(<span class="no">x</span>, <span class="kw">ahead</span> <span class="kw">=</span> <span class="fl">14</span>, <span class="kw">as_of</span> <span class="kw">=</span> <span class="fl">TRUE</span>),
                <span class="fu">k_week_ahead</span>(<span class="no">x</span>, <span class="kw">ahead</span> <span class="kw">=</span> <span class="fl">21</span>, <span class="kw">as_of</span> <span class="kw">=</span> <span class="fl">TRUE</span>),
                <span class="fu">k_week_ahead</span>(<span class="no">x</span>, <span class="kw">ahead</span> <span class="kw">=</span> <span class="fl">28</span>, <span class="kw">as_of</span> <span class="kw">=</span> <span class="fl">TRUE</span>),
                <span class="fu">k_week_ahead</span>(<span class="no">x</span>, <span class="kw">ahead</span> <span class="kw">=</span> <span class="fl">7</span>, <span class="kw">as_of</span> <span class="kw">=</span> <span class="fl">FALSE</span>),
                <span class="fu">k_week_ahead</span>(<span class="no">x</span>, <span class="kw">ahead</span> <span class="kw">=</span> <span class="fl">14</span>, <span class="kw">as_of</span> <span class="kw">=</span> <span class="fl">FALSE</span>),
                <span class="fu">k_week_ahead</span>(<span class="no">x</span>, <span class="kw">ahead</span> <span class="kw">=</span> <span class="fl">21</span>, <span class="kw">as_of</span> <span class="kw">=</span> <span class="fl">FALSE</span>),
                <span class="fu">k_week_ahead</span>(<span class="no">x</span>, <span class="kw">ahead</span> <span class="kw">=</span> <span class="fl">28</span>, <span class="kw">as_of</span> <span class="kw">=</span> <span class="fl">FALSE</span>))

<span class="co"># Now plot them, on top of latest COVID-19 case counts </span>
<span class="no">p</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="no">fc</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">target_date</span>, <span class="kw">group</span> <span class="kw">=</span> <span class="no">time_value</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="no">as_of</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">ymin</span> <span class="kw">=</span> <span class="no">fc_lower</span>, <span class="kw">ymax</span> <span class="kw">=</span> <span class="no">fc_upper</span>), <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.4</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">y</span> <span class="kw">=</span> <span class="no">fc_point</span>)) + <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">y</span> <span class="kw">=</span> <span class="no">fc_point</span>), <span class="kw">size</span> <span class="kw">=</span> <span class="fl">0.5</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">xintercept</span> <span class="kw">=</span> <span class="no">time_value</span>), <span class="kw">linetype</span> <span class="kw">=</span> <span class="fl">2</span>, <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.5</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html">facet_grid</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html">vars</a></span>(<span class="no">geo_value</span>), <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html">vars</a></span>(<span class="no">as_of</span>), <span class="kw">scales</span> <span class="kw">=</span> <span class="st">"free"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html">scale_x_date</a></span>(<span class="kw">minor_breaks</span> <span class="kw">=</span> <span class="st">"month"</span>, <span class="kw">date_labels</span> <span class="kw">=</span> <span class="st">"%b %y"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="st">"Date"</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="st">"Reported COVID-19 case rates"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="kw">legend.position</span> <span class="kw">=</span> <span class="st">"none"</span>)

<span class="kw pkg">gginnards</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/gginnards/man/delete_layers.html">append_layers</a></span>(
  <span class="no">p</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">x_latest</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">time_value</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">case_rates</span>),
               <span class="kw">inherit.aes</span> <span class="kw">=</span> <span class="fl">FALSE</span>, <span class="kw">color</span> <span class="kw">=</span> <span class="st">"gray50"</span>), <span class="kw">pos</span> <span class="kw">=</span> <span class="st">"bottom"</span>)</pre></body></html></div>
<p><img src="archive_files/figure-html/unnamed-chunk-12-1.png" width="864"></p>
<p>Each row displays the forecasts for a different location (CA and FL), and each column corresponds to whether properly-versioned data is used (<code>FALSE</code> means no, and <code>TRUE</code> means yes). We can see that the properly-versioned forecaster is, at some points in time, more problematic; for example, it massively overpredicts the peak in both locations in winter wave of 2020. However, performance is pretty poor across the board here, whether or not properly-versioned data is used. Similar to what we saw in the <a href="https://cmu-delphi.github.io/epiprocess/articles/archive.html">slide vignette</a>, the ARX forecasts can too volatile, overconfident, or both.</p>
<p>Some of the volatility can be attenuated here by training an ARX model jointly over locations; the <a href="https://cmu-delphi.github.io/epiprocess/articles/advanced.html">advanced sliding vignette</a> gives a demonstration of how to do this. But really, the <a href="https://cmu-delphi.github.io/epipredict/"><code>epipredict</code></a> package, which builds off the data structures and functionality in the current package, is the place to look for more robust forecasting methodology. The forecasters that appear in the vignettes in the current package are only meant to demo the slide functionality with some of the most basic forecasting methodology possible.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Logan Brooks, Rafael Catoia, Evan Ray, Ryan Tibshirani.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
