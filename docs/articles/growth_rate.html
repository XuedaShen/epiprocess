<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Estimate growth rates in signals • epiprocess</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Estimate growth rates in signals">
<meta property="og:description" content="epiprocess">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">epiprocess</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/epiprocess.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/slide.html">Slide a computation over signal values</a>
    </li>
    <li>
      <a href="../articles/growth_rate.html">Estimate growth rates in signals</a>
    </li>
    <li>
      <a href="../articles/correlation.html">Correlate signals over space and time</a>
    </li>
    <li>
      <a href="../articles/aggregation.html">Aggregate signals over space and time</a>
    </li>
    <li>
      <a href="../articles/outliers.html">Detect and correct outliers in signals</a>
    </li>
    <li>
      <a href="../articles/archive.html">Work with archive objects and data revisions</a>
    </li>
    <li>
      <a href="../articles/advanced.html">Advanced sliding with nonstandard outputs</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/cmu-delphi/epiprocess/tree/main/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="growth_rate_files/header-attrs-2.10/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Estimate growth rates in signals</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/cmu-delphi/epiprocess/blob/main/vignettes/growth_rate.Rmd"><code>vignettes/growth_rate.Rmd</code></a></small>
      <div class="hidden name"><code>growth_rate.Rmd</code></div>

    </div>

    
    
<p>A basic way of assessing growth in a signal is to look at its relative change over two neighboring time windows. The <code>epiprocess</code> package provides a function <code><a href="../reference/growth_rate.html">growth_rate()</a></code> to compute such relative changes, as well as more sophisticated estimates the growth rate of a signal. We investigate this functionality in the current vignette, applied to state-level daily reported COVID-19 cases from GA and PA, smoothed using a 7-day trailing average.</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">covidcast</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">epiprocess</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">dplyr</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">tidyr</span>)

<span class="no">x</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/covidcast/man/covidcast_signal.html">covidcast_signal</a></span>(<span class="st">"jhu-csse"</span>,
                      <span class="st">"confirmed_7dav_incidence_num"</span>,
                      <span class="kw">start_day</span> <span class="kw">=</span> <span class="st">"2020-06-01"</span>,
                      <span class="kw">end_day</span> <span class="kw">=</span> <span class="st">"2021-12-31"</span>,
                      <span class="kw">geo_type</span> <span class="kw">=</span> <span class="st">"state"</span>,
                      <span class="kw">geo_values</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"ga"</span>, <span class="st">"pa"</span>))  <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="no">geo_value</span>, <span class="no">time_value</span>, <span class="kw">cases</span> <span class="kw">=</span> <span class="no">value</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span>(<span class="no">geo_value</span>, <span class="no">time_value</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/as_epi_df.html">as_epi_df</a></span>()</pre></body></html></div>
<div id="growth-rate-basics" class="section level2">
<h2 class="hasAnchor">
<a href="#growth-rate-basics" class="anchor"></a>Growth rate basics</h2>
<p>The growth rate of a function <span class="math inline">\(f\)</span> defined over a continuously-valued parameter <span class="math inline">\(t\)</span> is defined as <span class="math inline">\(f'(t)/f(t)\)</span>, where <span class="math inline">\(f'(t)\)</span> is the derivative of <span class="math inline">\(f\)</span> at <span class="math inline">\(t\)</span>. To estimate the growth rate of a signal in discrete-time (which can be thought of as evaluations or discretizations of an underlying function in continuous-time), we can estimate the derivative and divide by the signal value itself (or possibly a smoothed version of the signal value).</p>
<p>The <code><a href="../reference/growth_rate.html">growth_rate()</a></code> function takes a sequence of underlying design points <code>x</code> and corresponding sequence <code>y</code> of signal values, and allows us to choose from the following methods for estimating the growth rate at a given reference point <code>x0</code>, by setting the <code>method</code> argument:</p>
<ul>
<li>“rel_change”: uses <span class="math inline">\((\bar B/\bar A - 1) / h\)</span>, where <span class="math inline">\(\bar B\)</span> is the average of <code>y</code> over the second half of a sliding window of bandwidth <code>h</code> centered at the reference point <code>x0</code>, and <span class="math inline">\(\bar A\)</span> the average over the first half. This can be seen as using a first-difference approximation to the derivative.</li>
<li>“linear_reg”: uses the slope from a linear regression of <code>y</code> on <code>x</code> over a sliding window centered at the reference point <code>x0</code>, divided by the fitted value from this linear regression at <code>x0</code>.</li>
<li>“smooth_spline”: uses the estimated derivative at <code>x0</code> from a smoothing spline fit to <code>x</code> and <code>y</code>, via <code><a href="https://rdrr.io/r/stats/smooth.spline.html">stats::smooth.spline()</a></code>, divided by the fitted value of the spline at <code>x0</code>.</li>
<li>“trend_filter”: uses the estimated derivative at <code>x0</code> from polynomial trend filtering (a discrete spline) fit to <code>x</code> and <code>y</code>, via <code><a href="https://rdrr.io/pkg/genlasso/man/trendfilter.html">genlasso::trendfilter()</a></code>, divided by the fitted value of the discrete spline at <code>x0</code>.</li>
</ul>
<p>The default in <code><a href="../reference/growth_rate.html">growth_rate()</a></code> is <code>x0 = x</code>, so that it returns an estimate of the growth rate at each underlying design point.</p>
</div>
<div id="relative-change" class="section level2">
<h2 class="hasAnchor">
<a href="#relative-change" class="anchor"></a>Relative change</h2>
<p>The default method is “rel_change”, which is the simplest way to estimate growth rates. The default bandwidth is <code>h = 7</code>, which for daily data, considers the relative change in a signal over adjacent weeks. We can wrap <code><a href="../reference/growth_rate.html">growth_rate()</a></code> in a call to <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">dplyr::mutate()</a></code> to append a new column to our <code>epi_df</code> object with the computed growth rates.</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="no">x</span> <span class="kw">&lt;-</span> <span class="no">x</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(<span class="no">geo_value</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">cases_gr1</span> <span class="kw">=</span> <span class="fu"><a href="../reference/growth_rate.html">growth_rate</a></span>(<span class="no">time_value</span>, <span class="no">cases</span>))

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">x</span>, <span class="fl">10</span>)</pre></body></html></div>
<pre><code>## # A tibble: 10 × 4
##    geo_value time_value cases cases_gr1
##    &lt;chr&gt;     &lt;date&gt;     &lt;dbl&gt;     &lt;dbl&gt;
##  1 ga        2020-06-01  643.   0.00601
##  2 ga        2020-06-02  603.   0.0185 
##  3 ga        2020-06-03  608    0.0240 
##  4 ga        2020-06-04  656.   0.0218 
##  5 ga        2020-06-05  677.   0.0193 
##  6 ga        2020-06-06  718.   0.0163 
##  7 ga        2020-06-07  691.   0.0180 
##  8 ga        2020-06-08  656.   0.0234 
##  9 ga        2020-06-09  720.   0.0227 
## 10 ga        2020-06-10  727.   0.0227</code></pre>
<p>We can visualize these growth rate estimates by plotting the signal values and highlighting the periods in time for which the relative change is above 1% (in red) and below -1% (in blue), faceting by geo value.</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">ggplot2</span>)
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html">theme_set</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span>())

<span class="no">upper</span> <span class="kw">=</span> <span class="fl">0.01</span>
<span class="no">lower</span> <span class="kw">=</span> -<span class="fl">0.01</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="no">x</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">time_value</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">cases</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html">geom_tile</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">x</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="no">cases_gr1</span> <span class="kw">&gt;=</span> <span class="no">upper</span>),
            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">time_value</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="fl">0</span>, <span class="kw">width</span> <span class="kw">=</span> <span class="fl">7</span>, <span class="kw">height</span> <span class="kw">=</span> <span class="fl">Inf</span>),
            <span class="kw">fill</span> <span class="kw">=</span> <span class="fl">2</span>, <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.08</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html">geom_tile</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">x</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="no">cases_gr1</span> <span class="kw">&lt;=</span> <span class="no">lower</span>),
            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">time_value</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="fl">0</span>, <span class="kw">width</span> <span class="kw">=</span> <span class="fl">7</span>, <span class="kw">height</span> <span class="kw">=</span> <span class="fl">Inf</span>),
            <span class="kw">fill</span> <span class="kw">=</span> <span class="fl">4</span>, <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.08</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>() +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html">vars</a></span>(<span class="no">geo_value</span>), <span class="kw">scales</span> <span class="kw">=</span> <span class="st">"free_y"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html">scale_x_date</a></span>(<span class="kw">minor_breaks</span> <span class="kw">=</span> <span class="st">"month"</span>, <span class="kw">date_labels</span> <span class="kw">=</span> <span class="st">"%b %y"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="st">"Date"</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="st">"Reported COVID-19 cases"</span>)</pre></body></html></div>
<p><img src="growth_rate_files/figure-html/unnamed-chunk-3-1.png" width="864"></p>
<p>As a more direct visualization, we plot the estimated growth rates themselves, overlaying the curves for the two states on one plot.</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="no">x</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">time_value</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">cases_gr1</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">col</span> <span class="kw">=</span> <span class="no">geo_value</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span>(<span class="kw">yintercept</span> <span class="kw">=</span> <span class="no">upper</span>, <span class="kw">linetype</span> <span class="kw">=</span> <span class="fl">2</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="fl">2</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span>(<span class="kw">yintercept</span> <span class="kw">=</span> <span class="no">lower</span>, <span class="kw">linetype</span> <span class="kw">=</span> <span class="fl">2</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="fl">4</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span>(<span class="kw">values</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">3</span>,<span class="fl">6</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html">scale_x_date</a></span>(<span class="kw">minor_breaks</span> <span class="kw">=</span> <span class="st">"month"</span>, <span class="kw">date_labels</span> <span class="kw">=</span> <span class="st">"%b %y"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="st">"Date"</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="st">"Growth rate"</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="st">"State"</span>)</pre></body></html></div>
<p><img src="growth_rate_files/figure-html/unnamed-chunk-4-1.png" width="700"></p>
<p>We can see that the estimated growth rates from the relative change method are somewhat volatile, and there appears to be some bias towards towards the right boundary of the time span—look at the estimated growth rate for Georgia in late December 2021, which takes a potentially suspicious dip. In general, estimation of derivatives will be difficult near the boundary, but relative changes can suffer from particularly noticeable boundary bias because they are based on a difference in averages over two halves of a local window, and with this simplistic approach, one of these halves will be truncated near a boundary.</p>
</div>
<div id="linear-regression" class="section level2">
<h2 class="hasAnchor">
<a href="#linear-regression" class="anchor"></a>Linear regression</h2>
<p>The second simplest method available is “linear_reg”, whose default bandwidth is again <code>h = 7</code>. Compared to “rel_change”, it appears to behave similarly overall, but thankfully avoids some of the troublesome spikes:</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="no">x</span> <span class="kw">&lt;-</span> <span class="no">x</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(<span class="no">geo_value</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">cases_gr2</span> <span class="kw">=</span> <span class="fu"><a href="../reference/growth_rate.html">growth_rate</a></span>(<span class="no">time_value</span>, <span class="no">cases</span>, <span class="kw">method</span> <span class="kw">=</span> <span class="st">"linear_reg"</span>))

<span class="no">x</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span>(<span class="kw">cols</span> <span class="kw">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/reexports.html">starts_with</a></span>(<span class="st">"cases_gr"</span>),
               <span class="kw">names_to</span> <span class="kw">=</span> <span class="st">"method"</span>,
               <span class="kw">values_to</span> <span class="kw">=</span> <span class="st">"gr"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">method</span> <span class="kw">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/recode.html">recode</a></span>(<span class="no">method</span>,
                         <span class="kw">cases_gr1</span> <span class="kw">=</span> <span class="st">"rel_change"</span>,
                         <span class="kw">cases_gr2</span> <span class="kw">=</span> <span class="st">"linear_reg"</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">time_value</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">gr</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">col</span> <span class="kw">=</span> <span class="no">method</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span>(<span class="kw">values</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">2</span>,<span class="fl">4</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html">vars</a></span>(<span class="no">geo_value</span>), <span class="kw">scales</span> <span class="kw">=</span> <span class="st">"free_y"</span>, <span class="kw">ncol</span> <span class="kw">=</span> <span class="fl">1</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html">scale_x_date</a></span>(<span class="kw">minor_breaks</span> <span class="kw">=</span> <span class="st">"month"</span>, <span class="kw">date_labels</span> <span class="kw">=</span> <span class="st">"%b %y"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="st">"Date"</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="st">"Growth rate"</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="st">"Method"</span>)</pre></body></html></div>
<p><img src="growth_rate_files/figure-html/unnamed-chunk-5-1.png" width="864"></p>
</div>
<div id="nonparametric-estimation" class="section level2">
<h2 class="hasAnchor">
<a href="#nonparametric-estimation" class="anchor"></a>Nonparametric estimation</h2>
<p>We can also use a nonparametric method to estimate the derivative, through “smooth_spline” or “trend_filter”. The latter is going to be generally more computationally expensive, but it is also able to adapt better to the local level of smoothness. (The apparent efficiency is actually compounded by the particular implementations and default settings for these methods: “trend_filter” is based on a full solution path algorithm provided in the <code>genlasso</code> package, and performs cross-validation by default in order to pick the level of regularization; read the documentation for <code><a href="../reference/growth_rate.html">growth_rate()</a></code> more details.)</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="no">x</span> <span class="kw">&lt;-</span> <span class="no">x</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(<span class="no">geo_value</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">cases_gr3</span> <span class="kw">=</span> <span class="fu"><a href="../reference/growth_rate.html">growth_rate</a></span>(<span class="no">time_value</span>, <span class="no">cases</span>, <span class="kw">method</span> <span class="kw">=</span> <span class="st">"smooth_spline"</span>),
         <span class="kw">cases_gr4</span> <span class="kw">=</span> <span class="fu"><a href="../reference/growth_rate.html">growth_rate</a></span>(<span class="no">time_value</span>, <span class="no">cases</span>, <span class="kw">method</span> <span class="kw">=</span> <span class="st">"trend_filter"</span>))

<span class="no">x</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="no">geo_value</span>, <span class="no">time_value</span>, <span class="no">cases_gr3</span>, <span class="no">cases_gr4</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span>(<span class="kw">cols</span> <span class="kw">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/reexports.html">starts_with</a></span>(<span class="st">"cases_gr"</span>),
               <span class="kw">names_to</span> <span class="kw">=</span> <span class="st">"method"</span>,
               <span class="kw">values_to</span> <span class="kw">=</span> <span class="st">"gr"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">method</span> <span class="kw">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/recode.html">recode</a></span>(<span class="no">method</span>,
                         <span class="kw">cases_gr3</span> <span class="kw">=</span> <span class="st">"smooth_spline"</span>,
                         <span class="kw">cases_gr4</span> <span class="kw">=</span> <span class="st">"trend_filter"</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">time_value</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">gr</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">col</span> <span class="kw">=</span> <span class="no">method</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span>(<span class="kw">values</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">3</span>,<span class="fl">6</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html">vars</a></span>(<span class="no">geo_value</span>), <span class="kw">scales</span> <span class="kw">=</span> <span class="st">"free_y"</span>, <span class="kw">ncol</span> <span class="kw">=</span> <span class="fl">1</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html">scale_x_date</a></span>(<span class="kw">minor_breaks</span> <span class="kw">=</span> <span class="st">"month"</span>, <span class="kw">date_labels</span> <span class="kw">=</span> <span class="st">"%b %y"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="st">"Date"</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="st">"Growth rate"</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="st">"Method"</span>)</pre></body></html></div>
<p><img src="growth_rate_files/figure-html/unnamed-chunk-6-1.png" width="864"></p>
<p>In this particular example, the trend filtering estimates of growth rate appear to be much more stable than those from the smoothing spline, and also much more stable than the estimates from local relative changes and linear regressions.</p>
<p>The smoothing spline growth rate estimates are based on the default settings in <code><a href="https://rdrr.io/r/stats/smooth.spline.html">stats::smooth.spline()</a></code>, and appear severely under-regularized here. Any of the arguments to <code><a href="https://rdrr.io/r/stats/smooth.spline.html">stats::smooth.spline()</a></code> can be customized by passing them as additional arguments <code>...</code> in the call to <code><a href="../reference/growth_rate.html">growth_rate()</a></code>; similarly, we can also use additional arguments to customize the settings in the underlying trend filtering functions <code><a href="https://rdrr.io/pkg/genlasso/man/trendfilter.html">genlasso::trendfilter()</a></code>, <code><a href="https://rdrr.io/pkg/genlasso/man/cv.trendfilter.html">genlasso::cv.trendfilter()</a></code>, and the documentation for <code><a href="../reference/growth_rate.html">growth_rate()</a></code> gives the full details.</p>
</div>
<div id="log-scale-estimation" class="section level2">
<h2 class="hasAnchor">
<a href="#log-scale-estimation" class="anchor"></a>Log scale estimation</h2>
<p>In general, and alternative view for the growth rate of a function <span class="math inline">\(f\)</span> is given by defining <span class="math inline">\(g(t) = \log(f(t))\)</span>, and then observing that <span class="math inline">\(g'(t) = f'(t)/f(t)\)</span>. Therefore, any method that estimates the derivative can be simply applied to the log of the signal of interest, and in this light, each method above (“rel_change”, “linear_reg”, “smooth_spline”, and “trend_filter”) has a log scale analog, which can be used by setting the argument <code>log_scale = TRUE</code> in the call to <code><a href="../reference/growth_rate.html">growth_rate()</a></code>.</p>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="no">x</span> <span class="kw">&lt;-</span> <span class="no">x</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(<span class="no">geo_value</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">cases_gr5</span> <span class="kw">=</span> <span class="fu"><a href="../reference/growth_rate.html">growth_rate</a></span>(<span class="no">time_value</span>, <span class="no">cases</span>, <span class="kw">method</span> <span class="kw">=</span> <span class="st">"rel_change"</span>,
                                 <span class="kw">log_scale</span> <span class="kw">=</span> <span class="fl">TRUE</span>),
         <span class="kw">cases_gr6</span> <span class="kw">=</span> <span class="fu"><a href="../reference/growth_rate.html">growth_rate</a></span>(<span class="no">time_value</span>, <span class="no">cases</span>, <span class="kw">method</span> <span class="kw">=</span> <span class="st">"linear_reg"</span>,
                                 <span class="kw">log_scale</span> <span class="kw">=</span> <span class="fl">TRUE</span>),
         <span class="kw">cases_gr7</span> <span class="kw">=</span> <span class="fu"><a href="../reference/growth_rate.html">growth_rate</a></span>(<span class="no">time_value</span>, <span class="no">cases</span>, <span class="kw">method</span> <span class="kw">=</span> <span class="st">"smooth_spline"</span>,
                                 <span class="kw">log_scale</span> <span class="kw">=</span> <span class="fl">TRUE</span>),
         <span class="kw">cases_gr8</span> <span class="kw">=</span> <span class="fu"><a href="../reference/growth_rate.html">growth_rate</a></span>(<span class="no">time_value</span>, <span class="no">cases</span>, <span class="kw">method</span> <span class="kw">=</span> <span class="st">"trend_filter"</span>,
                                 <span class="kw">log_scale</span> <span class="kw">=</span> <span class="fl">TRUE</span>))

<span class="no">x</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="no">geo_value</span>, <span class="no">time_value</span>, <span class="no">cases_gr5</span>, <span class="no">cases_gr6</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span>(<span class="kw">cols</span> <span class="kw">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/reexports.html">starts_with</a></span>(<span class="st">"cases_gr"</span>),
               <span class="kw">names_to</span> <span class="kw">=</span> <span class="st">"method"</span>,
               <span class="kw">values_to</span> <span class="kw">=</span> <span class="st">"gr"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">method</span> <span class="kw">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/recode.html">recode</a></span>(<span class="no">method</span>,
                         <span class="kw">cases_gr5</span> <span class="kw">=</span> <span class="st">"rel_change_log"</span>,
                         <span class="kw">cases_gr6</span> <span class="kw">=</span> <span class="st">"linear_reg_log"</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">time_value</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">gr</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">col</span> <span class="kw">=</span> <span class="no">method</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span>(<span class="kw">values</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">2</span>,<span class="fl">4</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html">vars</a></span>(<span class="no">geo_value</span>), <span class="kw">scales</span> <span class="kw">=</span> <span class="st">"free_y"</span>, <span class="kw">ncol</span> <span class="kw">=</span> <span class="fl">1</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html">scale_x_date</a></span>(<span class="kw">minor_breaks</span> <span class="kw">=</span> <span class="st">"month"</span>, <span class="kw">date_labels</span> <span class="kw">=</span> <span class="st">"%b %y"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="st">"Date"</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="st">"Growth rate"</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="st">"Method"</span>)</pre></body></html></div>
<p><img src="growth_rate_files/figure-html/unnamed-chunk-7-1.png" width="864"></p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="no">x</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="no">geo_value</span>, <span class="no">time_value</span>, <span class="no">cases_gr7</span>, <span class="no">cases_gr8</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span>(<span class="kw">cols</span> <span class="kw">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/reexports.html">starts_with</a></span>(<span class="st">"cases_gr"</span>),
               <span class="kw">names_to</span> <span class="kw">=</span> <span class="st">"method"</span>,
               <span class="kw">values_to</span> <span class="kw">=</span> <span class="st">"gr"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">method</span> <span class="kw">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/recode.html">recode</a></span>(<span class="no">method</span>,
                         <span class="kw">cases_gr7</span> <span class="kw">=</span> <span class="st">"smooth_spline_log"</span>,
                         <span class="kw">cases_gr8</span> <span class="kw">=</span> <span class="st">"trend_filter_log"</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">time_value</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">gr</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">col</span> <span class="kw">=</span> <span class="no">method</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span>(<span class="kw">values</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">3</span>,<span class="fl">6</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html">vars</a></span>(<span class="no">geo_value</span>), <span class="kw">scales</span> <span class="kw">=</span> <span class="st">"free_y"</span>, <span class="kw">ncol</span> <span class="kw">=</span> <span class="fl">1</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html">scale_x_date</a></span>(<span class="kw">minor_breaks</span> <span class="kw">=</span> <span class="st">"month"</span>, <span class="kw">date_labels</span> <span class="kw">=</span> <span class="st">"%b %y"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="st">"Date"</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="st">"Growth rate"</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="st">"Method"</span>)</pre></body></html></div>
<p><img src="growth_rate_files/figure-html/unnamed-chunk-7-2.png" width="864"></p>
<p>Comparing the <code>rel_change_log</code> curves with their <code>rel_change</code> counterparts (shown in earlier figures), we see that the former curves appear less volatile and match the linear regression estimates much more closely. In particular, when <code>rel_change</code> has upward spikes, <code>rel_change_log</code> has less pronounced spikes. Why does this occur? The estimate of <span class="math inline">\(g'(t)\)</span> here can be expressed as <span class="math inline">\(\mathbb E[\log(B)-\log(A)]/h = \mathbb E[\log(1+hR)]/h\)</span>, where <span class="math inline">\(R = ((B-A)/h) / A\)</span>, and the expectation refers to averaging over the <span class="math inline">\(h\)</span> observations in each window. Consider the following two relevant inequalities, both due to concavity of the logarithm function:</p>
<p><span class="math display">\[
\mathbb E[\log(1+hR)]/h \leq \log(1+h\mathbb E[R])/h \leq \mathbb E[R].
\]</span></p>
<p>The first inequality is Jensen’s; the second inequality is because the tangent line of a concave function lies above it. Finally, we observe that <span class="math inline">\(\mathbb E[R] \approx ((\bar B-\bar A)/h) / \bar A\)</span>, which the <code>rel_change</code> estimate.<br>
This explains why the <code>rel_change_log</code> curve often lies below the <code>rel_change</code> curve.</p>
<!-- Whether or not a log transform is used should likely be informed by the 
working model for noise. *todo: write something intelligent here?* -->
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Logan Brooks, Evan Ray, Ryan Tibshirani.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
